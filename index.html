<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Math Exam Editor v2.8 (Final Fix)</title>
    <script>
        // [Fix 1] MathJax ì„¤ì • ì¶©ëŒ í•´ê²° (loader ì œê±°)
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                packages: ['base', 'ams', 'noerrors', 'noundefined']
            },
            svg: { 
                fontCache: 'global',
                scale: 1.0,
                displayAlign: 'left' // ìˆ˜ì‹ ì¢Œì¸¡ ì •ë ¬
            },
            startup: { 
                typeset: false, // ìˆ˜ë™ ì œì–´ ëª¨ë“œ
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax Engine Ready');
                        window.isMathJaxReady = true;
                    });
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* [ê¸°ë³¸ ì„¤ì •] */
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; font-family: 'Noto Sans KR', sans-serif; background-color: #525659; }

        /* [ìˆ˜ì‹ Atom ìŠ¤íƒ€ì¼] */
        mjx-container { 
            display: inline-block !important; 
            vertical-align: middle !important; 
            margin: 0 2px; 
            cursor: pointer; 
            user-select: none; /* Atomì²˜ëŸ¼ ì„ íƒ ë°©ì§€ */
        }
        mjx-container:hover { background-color: rgba(0, 123, 255, 0.1); border-radius: 4px; }
        mjx-container:focus { outline: 2px solid #007bff; border-radius: 4px; }

        /* [UI ìŠ¤íƒ€ì¼] */
        #drop-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 123, 255, 0.85); z-index: 9999; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; pointer-events: none; flex-direction: column; gap: 10px; }
        body.drag-over #drop-overlay { display: flex; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 700px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 15px; }
        .modal-textarea { width: 100%; height: 250px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; font-size: 12px; resize: none; background: #f8f9fa; color: #333; }

        /* [ì°¾ê¸°/ë°”ê¾¸ê¸° ëª¨ë‹¬] */
        #find-replace-modal .modal-content { width: 400px; padding: 20px; gap: 10px; }
        .fr-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .fr-label { width: 80px; font-size: 13px; font-weight: bold; color: #333; }
        .fr-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .fr-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }

        /* [ë ˆì´ì•„ì›ƒ] */
        .sidebar { width: 340px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 15px; z-index: 200; flex-shrink: 0; overflow-y: auto; }
        .workspace { flex-grow: 1; overflow: auto; display: flex; flex-direction: column; align-items: center; padding: 40px 0; background-color: #525659; }
        
        #loading-indicator { position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; display: none; z-index: 11000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 0.8; } }

        /* [í˜ì´ì§€] */
        .page { width: 210mm; height: 297mm; padding: 15mm 10mm; background: white; position: relative; box-shadow: 0 5px 20px rgba(0,0,0,0.5); margin-bottom: 30px; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; transform-origin: top center; transition: transform 0.1s; }
        .header-area { width: 100%; margin-bottom: 10px; flex-shrink: 0; }
        .header-table { width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 10pt; table-layout: fixed; }
        .header-table td { border: 1px solid #000; padding: 5px; text-align: center; height: 35px; vertical-align: middle; }
        .col-title { width: 15%; background-color: #f0f0f0; font-weight: bold; }
        .col-label { width: 10%; background-color: #f0f0f0; font-weight: bold; }
        .col-input-wide { width: 45%; }
        .col-input-narrow { width: 20%; }
        .header-input, .footer-input { width: 100%; border: none; text-align: center; font-family: inherit; font-size: inherit; background: transparent; }
        .header-line { width: 100%; border-bottom: 1px solid #000; height: 1px; margin-bottom: 10px; }
        .page-footer { flex-shrink: 0; margin-top: auto; width: 100%; z-index: 10; background: white; text-align: center; font-size: 10pt; }
        .footer-content-first { border-top: 1px solid #000; padding-top: 5px; }
        .footer-line { width: 100%; border-top: 1px solid #000; height: 1px; margin-bottom: 5px; }
        .body-container { flex-grow: 1; display: flex; position: relative; width: 100%; align-items: flex-start; }
        .body-container::after { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 0; border-left: 1px solid #000; transform: translateX(-0.5px); z-index: 0; }
        .column { width: 50%; height: 100%; display: flex; flex-direction: column; padding-right: 5mm; z-index: 1; }
        .column.right { padding-right: 0; padding-left: 5mm; }

        /* [ë¸”ë¡ ìš”ì†Œ] */
        .block-wrapper { position: relative; margin-bottom: 2px; width: 100%; flex-shrink: 0; border-radius: 4px; border: 1px solid transparent; transition: background 0.1s; }
        .block-wrapper:hover { background-color: rgba(0,0,0,0.03); }
        .block-wrapper.bg-gray-block { background-color: #f1f3f5; border-radius: 6px; padding: 5px; margin-bottom: 5px; border: 1px solid #e9ecef; }
        
        .block-handle { position: absolute; left: -25px; top: 0; width: 25px; height: 100%; cursor: grab; display: flex; align-items: flex-start; padding-top: 5px; justify-content: center; opacity: 0; color: #aaa; z-index: 100; font-size: 18px; transition: opacity 0.2s; }
        .block-wrapper:hover .block-handle { opacity: 1; }
        .block-handle::after { content: 'â‹®â‹®'; font-size: 16px; }
        
        .block-wrapper.dragging { opacity: 0.4; background: #e2e6ea; }
        .drop-target-top { border-top: 3px solid #007bff; margin-top: -3px; }
        .drop-target-bottom { border-bottom: 3px solid #007bff; margin-bottom: -3px; }

        .editable-box { 
            border-radius: 4px; padding: 2px 2px;
            font-family: 'Noto Serif KR', serif; font-size: 10.5pt; line-height: 1.6; 
            text-align: inherit; word-break: break-all; min-height: 28px; width: 100%; cursor: text;
        }
        .editable-box.bordered-box { border: 1px solid #333; padding: 8px 10px; border-radius: 6px; background: #fff; }
        .editable-box img { max-width: 100%; cursor: pointer; } 
        .editable-box img[src=""]::before { content: 'âŒ ì´ë¯¸ì§€ ì—†ìŒ'; color: red; border: 1px dashed red; padding: 10px; display: block; }

        .concept-box { border: 1px solid #333; border-radius: 6px; background: #fff; padding: 8px 10px; margin-bottom: 5px; width: 100%; }
        .q-label { color: #1a6fc0; font-weight: 800; font-family: 'Noto Sans KR', sans-serif; margin-right: 5px; }
        .blank-label { display: inline-block; border: 1px solid #333; padding: 0 8px; margin: 0 2px; min-width: 30px; text-align: center; font-weight: bold; background: #fff; font-family: 'Noto Sans KR', sans-serif; font-size: 0.95em; vertical-align: middle; }

        .spacer-block { width: 100%; background: repeating-linear-gradient(45deg, #f9f9f9, #f9f9f9 10px, #fff 10px, #fff 20px); border: 1px dashed #ddd; cursor: ns-resize; display: flex; align-items: center; justify-content: center; margin: 5px 0; }
        .break-line { height: 24px; border-bottom: 2px dotted #ff4444; margin: 5px 0 15px 0; text-align: center; color: #ff4444; font-size: 11px; cursor: pointer; background: rgba(255, 200, 200, 0.1); }
        .break-line:hover::after { content: ' (í´ë¦­í•˜ì—¬ ì‚­ì œ)'; }

        .image-placeholder { display: inline-block; width: 100%; padding: 20px; border: 2px dashed #007bff; background-color: #f0f7ff; color: #0056b3; text-align: center; cursor: pointer; font-size: 12px; border-radius: 6px; font-weight: bold; user-select: none; }
        .image-placeholder.selected { border: 2px solid #0056b3; background-color: #dbeafe; box-shadow: 0 0 0 3px rgba(0,123,255,0.25); outline: none; }

        /* [íˆ´ë°”] */
        #floating-toolbar { position: absolute; background: #333; border-radius: 6px; padding: 5px; display: none; gap: 5px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transform: translate(-50%, -120%); }
        #floating-toolbar::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .ft-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; }
        .ft-btn:hover { background: rgba(255,255,255,0.2); }
        .ft-sep { width: 1px; background: rgba(255,255,255,0.3); margin: 0 2px; height: 20px; align-self: center; }

        #image-resizer { position: absolute; border: 2px solid #007bff; z-index: 9900; display: none; pointer-events: none; }
        .resizer-handle { position: absolute; width: 10px; height: 10px; background: #007bff; border: 1px solid white; pointer-events: auto; }
        .rh-se { bottom: -6px; right: -6px; cursor: nwse-resize; }

        #context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 6px; z-index: 9999; display: none; width: 230px; }
        .menu-item { padding: 8px 12px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; color: #333; }
        .menu-item:hover { background: #e7f5ff; color: #007bff; }
        .menu-sep { height: 1px; background: #eee; margin: 4px 0; }
        .menu-title { font-size: 10px; color: #888; padding: 5px 10px; background: #f8f9fa; font-weight: bold; }
        .shortcut-badge { font-size: 10px; color: #999; background: #f1f3f5; padding: 1px 4px; border-radius: 3px; }

        .btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .btn:hover { background: #f8f9fa; }
        .btn-primary { background: #007bff; color: white; border: none; font-weight: bold; }
        .btn-warning { background: #ffc107; color: #212529; border: none; font-weight: bold; }
        .btn-success { background: #28a745; color: white; border: none; font-weight: bold; }
        .btn-danger { background: #dc3545; color: white; border: none; font-weight: bold; }
        .btn-purple { background: #6f42c1; color: white; border: none; font-weight: bold; }
        .btn-sm { padding: 4px 8px; width: auto; font-size: 12px; }

        .settings-panel { background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; padding:10px; margin-bottom:15px; }
        .settings-row { display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:5px; }
        .settings-row label { color:#333; font-weight:bold; }
        .settings-row input[type="number"], .settings-row input[type="text"] { width:60px; padding:2px; text-align:center; border:1px solid #ddd; border-radius:3px; }

        #folder-status { font-size: 11px; color: #28a745; font-weight: bold; display: none; margin-bottom: 5px; }
        #folder-status.active { display: block; }
        
        .shortcut-guide { margin-top: 15px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 0; font-size: 11px; color: #333; height: 220px; overflow-y: auto; }
        .shortcut-header { background: #f1f3f5; padding: 8px; font-weight: bold; font-size: 12px; border-bottom: 1px solid #ddd; position: sticky; top:0; }
        .shortcut-list { padding: 5px; }
        .shortcut-item { display: flex; justify-content: space-between; padding: 4px 8px; border-bottom: 1px dashed #eee; }
        .shortcut-item:last-child { border-bottom: none; }
        .shortcut-key { font-weight: bold; color: #007bff; background: #e7f5ff; padding: 1px 5px; border-radius: 3px; font-family: monospace; }
        
        @media print {
            @page { size: A4 portrait; margin: 0; }
            .sidebar, #floating-toolbar, #image-resizer, #context-menu, .block-handle, #loading-indicator, #drop-overlay, .modal-overlay { display: none !important; }
            body, .workspace { background: white; overflow: visible; display: block; margin: 0; padding: 0; }
            .page { display: flex !important; flex-direction: column !important; margin: 0; box-shadow: none; border: none; page-break-after: always; transform: none !important; width: 210mm; height: 297mm !important; overflow: hidden !important; }
            .page.page-first { height: 297mm !important; }
            .body-container { flex-grow: 1 !important; margin-bottom: 0 !important; height: auto !important; }
            .page-footer { flex-shrink: 0; margin-top: auto !important; width: 100%; z-index: 10; background: white; }
            .image-placeholder, .break-line { display: none; }
            .bg-gray-block { background-color: #f1f3f5 !important; -webkit-print-color-adjust: exact; }
            .spacer-block { border: none !important; background: none !important; }
        }
    </style>
</head>
<body>

<div id="loading-indicator">ğŸ”„ ì²˜ë¦¬ ì¤‘...</div>
<div id="drop-overlay">ğŸ“‚ íŒŒì¼ ë†“ê¸° (Import)</div>
<input type="file" id="imgUpload" accept="image/*" style="display:none;">

<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; display:flex; justify-content:space-between;">
            <span>ğŸ“¥ AI ë°ì´í„° ì…ë ¥ (í˜¸í™˜ ëª¨ë“œ)</span>
            <span style="cursor:pointer;" onclick="closeModal('import-modal')">Ã—</span>
        </div>
        <textarea id="import-textarea" class="modal-textarea" placeholder="ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-warning" onclick="confirmImport(true)" style="width:auto;">ë®ì–´ì“°ê¸°</button>
            <button class="btn btn-primary" onclick="confirmImport(false)" style="width:auto;">ì´ì–´ì“°ê¸°</button>
            <button class="btn" onclick="closeModal('import-modal')" style="width:auto;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="find-replace-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; font-size:16px;">ğŸ” ì¼ê´„ ë°”ê¾¸ê¸°</div>
        <div class="fr-row">
            <span class="fr-label">ì°¾ì„ ë‚´ìš©</span>
            <input type="text" id="fr-find-input" class="fr-input" placeholder="ì°¾ì„ í…ìŠ¤íŠ¸">
        </div>
        <div class="fr-row">
            <span class="fr-label">ë°”ê¿€ ë‚´ìš©</span>
            <input type="text" id="fr-replace-input" class="fr-input" placeholder="ë°”ê¿€ í…ìŠ¤íŠ¸">
        </div>
        <div class="fr-actions">
            <button class="btn btn-primary btn-sm" onclick="executeFindReplace()">ëª¨ë‘ ë°”ê¾¸ê¸°</button>
            <button class="btn btn-sm" onclick="closeModal('find-replace-modal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="floating-toolbar">
    <button class="ft-btn" onmousedown="execStyle('bold')" title="êµµê²Œ">B</button>
    <button class="ft-btn" onmousedown="execStyle('italic')" title="ê¸°ìš¸ì„">I</button>
    <button class="ft-btn" onmousedown="execStyle('underline')" title="ë°‘ì¤„">U</button>
    <div class="ft-sep"></div>
    <button class="ft-btn" onmousedown="execStyle('justifyLeft')" title="ì™¼ìª½">â‡¤</button>
    <button class="ft-btn" onmousedown="execStyle('justifyCenter')" title="ê°€ìš´ë°">â†”</button>
    <button class="ft-btn" onmousedown="execStyle('justifyRight')" title="ì˜¤ë¥¸ìª½">â‡¥</button>
    <div class="ft-sep"></div>
    <button class="ft-btn" onmousedown="execStyle('foreColor', '#dc3545')" style="color:#dc3545">â—</button>
    <button class="ft-btn" onmousedown="execStyle('foreColor', '#007bff')" style="color:#007bff">â—</button>
    <button class="ft-btn" onmousedown="execStyle('foreColor', '#000000')">â—</button>
</div>

<div id="image-resizer">
    <div class="resizer-handle rh-se"></div>
</div>

<div id="context-menu">
    <div class="menu-title">ë¸”ë¡ í¸ì§‘</div>
    <div class="menu-item" onclick="toggleGrayBg()"><span>ğŸ¨ íšŒìƒ‰ ë°°ê²½</span><span class="shortcut-badge">Ctrl+Alt+G</span></div>
    <div class="menu-item" onclick="toggleBorder()"><span>ğŸ”² í…Œë‘ë¦¬ ë°•ìŠ¤</span><span class="shortcut-badge">Ctrl+Alt+B</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="applyAlign('left')"><span>â‡¤ ì™¼ìª½ ì •ë ¬</span><span class="shortcut-badge">Ctrl+Sh+L</span></div>
    <div class="menu-item" onclick="applyAlign('center')"><span>â†” ê°€ìš´ë° ì •ë ¬</span><span class="shortcut-badge">Ctrl+Sh+M</span></div>
    <div class="menu-item" onclick="applyAlign('right')"><span>â‡¥ ì˜¤ë¥¸ìª½ ì •ë ¬</span><span class="shortcut-badge">Ctrl+Sh+R</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="duplicateTargetBlock()"><span>ğŸ“‹ ë³µì œí•˜ê¸°</span><span class="shortcut-badge">Ctrl+D</span></div>
    <div class="menu-item" onclick="addBlockAbove('example')"><span>â• ìœ„ì— ì¶”ê°€</span><span class="shortcut-badge">Alt+Enter</span></div>
    <div class="menu-item" onclick="addBlockBelow('example')"><span>â• ì•„ë˜ì— ì¶”ê°€</span><span class="shortcut-badge">Enter</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="insertImageBoxSafe()"><span>ğŸ–¼ï¸ ì´ë¯¸ì§€ ë°•ìŠ¤ ì¶”ê°€</span><span class="shortcut-badge">Ctrl+Alt+I</span></div>
    <div class="menu-item" onclick="addBlockBelow('spacer')"><span>â†• ì—¬ë°± ë¸”ë¡ ì¶”ê°€</span><span class="shortcut-badge">Ctrl+Alt+S</span></div>
    <div class="menu-item" onclick="addBlockBelow('break')"><span>âš¡ ë‹¨ ë‚˜ëˆ„ê¸° ì¶”ê°€</span><span class="shortcut-badge">Ctrl+Enter</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="deleteTargetBlock()" style="color:#dc3545;"><span>ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</span><span class="shortcut-badge">Delete</span></div>
</div>

<nav class="sidebar">
    <div style="font-weight:bold; font-size:16px; margin-bottom:15px; border-bottom:2px solid #333; padding-bottom:5px;">
        ğŸ“ ìˆ˜í•™ ì—ë””í„° v2.8
        <div style="font-size:10px; color:#666; font-weight:normal;">Final Fix (Render/Drag)</div>
    </div>
    
    <div class="settings-panel" style="background:#e8f5e9; border:1px solid #c8e6c9;">
        <div style="font-size:11px; font-weight:bold; margin-bottom:5px;">ğŸ“‚ ë¡œì»¬ ì‘ì—… í´ë” (í•„ìˆ˜)</div>
        <div id="folder-status">âœ… í´ë” ì—°ê²°ë¨</div>
        <div class="settings-row">
            <label>ì´ë¯¸ì§€ í´ë”ëª…</label>
            <input type="text" id="setting-img-folder" value="images" style="width:80px;">
        </div>
        <button class="btn btn-success" onclick="FileSystem.openProjectFolder()">ğŸ“‚ ì‘ì—… í´ë” ì—´ê¸°</button>
        <div style="font-size:10px; color:#666; margin-top:5px;">* Ctrl+S ì €ì¥ ì‹œ íŒŒì¼ì´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</div>
    </div>

    <button class="btn btn-purple" onclick="ManualRenderer.renderAll()" style="margin-bottom:15px; padding: 12px;">
        âš¡ ìˆ˜ì‹ ë³€í™˜ (Render)<br>
        <span style="font-size:10px; opacity:0.8;">Click: $..$ â†’ SVG / DblClick: Edit</span>
    </button>

    <div style="margin-bottom:10px;">
        <span style="font-size:12px;">í™•ëŒ€/ì¶•ì†Œ</span>
        <input type="range" id="zoomRange" min="0.5" max="1.5" step="0.1" value="1.0" style="width: 100%;">
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <button class="btn" style="width:48%" onclick="performUndo()" title="ì‹¤í–‰ ì·¨ì†Œ">â†¶ Undo<br><span style="font-size:9px;">(Ctrl+Z)</span></button>
        <button class="btn" style="width:48%" onclick="performRedo()" title="ë‹¤ì‹œ ì‹¤í–‰">â†· Redo<br><span style="font-size:9px;">(Ctrl+Shift+Z)</span></button>
    </div>

    <button class="btn btn-success" onclick="insertImageBoxSafe()" style="margin-bottom:15px;">
        ğŸ–¼ï¸ ì´ë¯¸ì§€ ë°•ìŠ¤ ë„£ê¸° (Ctrl+Alt+I)
    </button>

    <div class="settings-panel">
        <div style="font-size:11px; font-weight:bold; margin-bottom:5px; border-bottom:1px solid #ddd; padding-bottom:3px;">âš™ï¸ AI ì…ë ¥ ì„¤ì •</div>
        <div class="settings-row">
            <label>ë‹¨ë³„ ë¬¸ì œ ìˆ˜</label>
            <input type="number" id="setting-limit" value="0" title="0ì´ë©´ ì œí•œ ì—†ìŒ">
        </div>
        <div class="settings-row">
            <label>ìë™ ì—¬ë°±</label>
            <input type="checkbox" id="setting-spacer" checked>
        </div>
    </div>

    <div style="border-top:1px solid #eee; padding-top:10px;">
        <button class="btn" onclick="openModal('import-modal')" style="border-left: 3px solid #6f42c1; color: #6f42c1; font-weight:bold;">ğŸ“¥ AI ë°ì´í„° ì…ë ¥ (Alt+I)</button>
        <button class="btn btn-warning" onclick="resetProject()">ğŸ—‘ï¸ ì´ˆê¸°í™” (Alt+N)</button>
        <button class="btn btn-primary" onclick="saveProjectJSON()">ğŸ’¾ ì €ì¥ (Ctrl+S)</button>
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ì—´ê¸° (Ctrl+O)</button>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadProjectJSON(this)">
    </div>

    <div class="shortcut-guide">
        <div class="shortcut-header">âŒ¨ï¸ ë‹¨ì¶•í‚¤ ê°€ì´ë“œ</div>
        <div class="shortcut-list">
            <div class="shortcut-item"><span>ê³µë°±(10ì¹¸)</span><span class="shortcut-key">Sh+Tab</span></div>
            <div class="shortcut-item"><span>ë‹¤ìŒ/ì´ì „ ë¸”ë¡</span><span class="shortcut-key">Tab / Ctrl+Tab</span></div>
            <div class="shortcut-item"><span>ì‹¤í–‰ ì·¨ì†Œ/ë³µêµ¬</span><span class="shortcut-key">Ctrl+(Sh)+Z</span></div>
            <div class="shortcut-item"><span>ìƒˆ ë¬¸ì œ ì¶”ê°€</span><span class="shortcut-key">Enter</span></div>
            <div class="shortcut-item"><span>ìœ„ì— ì¶”ê°€</span><span class="shortcut-key">Alt+Enter</span></div>
            <div class="shortcut-item"><span>ë‹¨ ë‚˜ëˆ„ê¸°</span><span class="shortcut-key">Ctrl+Enter</span></div>
            <div class="shortcut-item"><span>ì°¾ê¸°/ë°”ê¾¸ê¸°</span><span class="shortcut-key">Ctrl+Q+F</span></div>
            <div class="shortcut-item"><span>ë¸”ë¡ í…Œë‘ë¦¬</span><span class="shortcut-key">Ctrl+Alt+B</span></div>
            <div class="shortcut-item"><span>ë¸”ë¡ ìŒì˜</span><span class="shortcut-key">Ctrl+Alt+G</span></div>
            <div class="shortcut-item"><span>ì´ë¯¸ì§€ ë°•ìŠ¤</span><span class="shortcut-key">Ctrl+Alt+I</span></div>
            <div class="shortcut-item"><span>ì •ë ¬(ì¢Œ/ì¤‘/ìš°)</span><span class="shortcut-key">Ctrl+Sh+L/M/R</span></div>
        </div>
    </div>

    <div style="margin-top:auto;">
        <button class="btn btn-danger" onclick="printWithMath()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
    </div>
</nav>

<main class="workspace" id="workspace">
    <div id="paper-container"></div>
</main>

<script>
    // [ì „ì—­ ìƒíƒœ]
    let docData = {
        meta: { title: "ì‹œí—˜ì§€ ì œëª©", subtitle: "ë‹¨ì›ëª…", footerText: "í•™ì›ëª…", zoom: 1.0 },
        blocks: [ { id: 'b0', type: 'concept', content: '<span class="q-label">ì•ˆë‚´</span> ë‚´ìš© ì…ë ¥...' } ]
    };
    let historyStack = []; let historyIndex = -1; 
    let selectedPlaceholder = null; let selectedImage = null; 
    let contextTargetId = null; let dragSrcId = null;
    let renderTimer = null; let keysPressed = {}; 
    let lastFocusId = null;
    window.isMathJaxReady = false;

    // [í•µì‹¬ ì—”ì§„] ìˆ˜ë™ ë Œë”ë§ (ManualRenderer) - Final Patch
    const ManualRenderer = {
        async renderAll() {
            if (!window.isMathJaxReady) { alert("MathJax ì—”ì§„ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."); return; }
            showLoading("âš¡ ìˆ˜ì‹ ë³€í™˜ ì¤‘...");
            
            // [íŒ¨ì¹˜ 1] ìˆ˜ì‹ ìŠ¤íƒ€ì¼(CSS)ì´ ëˆ„ë½ë˜ì§€ ì•Šë„ë¡ ê°•ì œ ì£¼ì…
            if (!document.getElementById('MJX-SVG-styles')) {
                const sheet = MathJax.svgStylesheet();
                document.head.appendChild(sheet);
            }

            // ëª¨ë“  í¸ì§‘ ë°•ìŠ¤(ì „ì²´ í˜ì´ì§€)ë¥¼ ìˆœíšŒí•˜ë©° ìˆ˜ì‹ ë³€í™˜
            const boxes = document.querySelectorAll('.editable-box');
            for (let box of boxes) {
                await this.typesetElement(box);
            }
            hideLoading();
            this.syncAllBlocks();
        },

        async typesetElement(element) {
            const regex = /(\$[^$]+\$|\$\$[^$]+\$\$)/g;
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            while(walker.nextNode()) textNodes.push(walker.currentNode);

            for (let node of textNodes) {
                // ì´ë¯¸ ë³€í™˜ëœ ìš”ì†Œë‚˜ ìŠ¤íƒ€ì¼ íƒœê·¸ëŠ” ê±´ë„ˆëœ€
                if (node.parentNode.tagName === 'MJX-CONTAINER' || node.parentNode.tagName === 'STYLE') continue;
                
                const text = node.nodeValue;
                if (!text.match(regex)) continue;

                const fragment = document.createDocumentFragment();
                let lastIndex = 0; regex.lastIndex = 0; let match;

                while ((match = regex.exec(text)) !== null) {
                    if (match.index > lastIndex) fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                    
                    const fullTex = match[0];
                    const cleanTex = fullTex.replace(/^\$\$|\$\$?$/g, '');
                    const isDisplay = fullTex.startsWith('$$');

                    try {
                        // [íŒ¨ì¹˜ 2] í•µì‹¬ ìˆ˜ì •: .querySelector ì‚­ì œ -> ë³€í™˜ ê°ì²´ ì§ì ‘ ì‚¬ìš©
                        const mjxContainer = await MathJax.tex2svgPromise(cleanTex, { display: isDisplay });
                        
                        // [íŒ¨ì¹˜ 3] Atom ê¸°ëŠ¥(í•œ ë©ì–´ë¦¬ ì´ë™/ì‚­ì œ) ë° ë°ì´í„° ë³´ì¡´ ì™„ë²½ ìœ ì§€
                        if (mjxContainer) {
                            mjxContainer.setAttribute('data-tex', cleanTex); 
                            mjxContainer.setAttribute('contenteditable', 'false'); // ì»¤ì„œ ì§„ì… ë°©ì§€
                            mjxContainer.classList.add('math-atom');
                            fragment.appendChild(mjxContainer);
                        } else {
                            fragment.appendChild(document.createTextNode(fullTex));
                        }
                    } catch(e) { 
                        console.error("MathJax Render Error:", e);
                        fragment.appendChild(document.createTextNode(fullTex)); 
                    }
                    lastIndex = regex.lastIndex;
                }
                if (lastIndex < text.length) fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                node.parentNode.replaceChild(fragment, node);
            }
        },

        revertToSource(mjxContainer) {
            const tex = mjxContainer.getAttribute('data-tex');
            if (tex) {
                const textNode = document.createTextNode('$' + tex + '$');
                mjxContainer.replaceWith(textNode);
            }
        },

        syncAllBlocks() {
            document.querySelectorAll('.block-wrapper').forEach(wrap => {
                const id = wrap.dataset.id;
                const box = wrap.querySelector('.editable-box');
                if (box) updateBlockContent(id, box.innerHTML, false);
            });
            saveHistoryDebounced();
        }
    };

    // [ì´ë²¤íŠ¸] ë”ë¸”í´ë¦­ -> ìˆ˜ì‹ í¸ì§‘ ëª¨ë“œ
    document.addEventListener('dblclick', (e) => {
        const mjx = e.target.closest('mjx-container');
        if (mjx) {
            e.preventDefault(); e.stopPropagation();
            ManualRenderer.revertToSource(mjx);
            const wrap = e.target.closest('.block-wrapper');
            if(wrap) {
                const box = wrap.querySelector('.editable-box');
                updateBlockContent(wrap.dataset.id, box.innerHTML);
            }
        }
    });

    const FileSystem = {
        dirHandle: null,
        async openProjectFolder() {
            try {
                this.dirHandle = await window.showDirectoryPicker();
                document.getElementById('folder-status').classList.add('active');
                alert("âœ… í´ë”ê°€ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.\n[images] í´ë”ì™€ [data.json] íŒŒì¼ì´ ì´ í´ë”ì— ìƒì„±/ì €ì¥ë©ë‹ˆë‹¤.");
            } catch (e) { console.error(e); alert("í´ë” ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤."); }
        },
        async saveImage(file) {
            if (!this.dirHandle) { alert("âš ï¸ ë¨¼ì € [ğŸ“‚ ì‘ì—… í´ë” ì—´ê¸°]ë¥¼ ëˆŒëŸ¬ í´ë”ë¥¼ ì—°ê²°í•´ì£¼ì„¸ìš”!"); return null; }
            try {
                const folderName = document.getElementById('setting-img-folder').value || 'images';
                const imgDir = await this.dirHandle.getDirectoryHandle(folderName, { create: true });
                const timestamp = new Date().toISOString().replace(/[-:T.]/g, '').slice(2, 14); 
                const ext = file.name.split('.').pop() || 'png';
                const filename = `img_${timestamp}.${ext}`;
                const fileHandle = await imgDir.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(file);
                await writable.close();
                const savedFile = await fileHandle.getFile();
                return { filename: filename, url: URL.createObjectURL(savedFile), path: `./${folderName}/${filename}` };
            } catch (e) { alert("ì´ë¯¸ì§€ ì €ì¥ ì‹¤íŒ¨: " + e.message); return null; }
        },
        async loadImagesForDisplay(blocks) {
            if (!this.dirHandle) return;
            const folderName = document.getElementById('setting-img-folder').value || 'images';
            try {
                const imgDir = await this.dirHandle.getDirectoryHandle(folderName);
                for (let block of blocks) {
                    if (block.content.includes('<img')) {
                        const div = document.createElement('div'); div.innerHTML = block.content;
                        const imgs = div.querySelectorAll('img'); let modified = false;
                        for (let img of imgs) {
                            const src = img.getAttribute('src');
                            if (src && src.startsWith(`./${folderName}/`)) {
                                const filename = src.split('/').pop();
                                try { const fh = await imgDir.getFileHandle(filename); const f = await fh.getFile(); img.src = URL.createObjectURL(f); modified = true; } catch (e) { console.warn("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:", filename); }
                            }
                        }
                        if (modified) block.content = div.innerHTML;
                    }
                }
            } catch (e) { console.log("ì´ë¯¸ì§€ í´ë” ì—†ìŒ"); }
        },
        async cleanUpImages(blocks) {
            if (!this.dirHandle) return;
            const folderName = document.getElementById('setting-img-folder').value || 'images';
            try {
                const usedFiles = new Set();
                blocks.forEach(b => {
                    const div = document.createElement('div'); div.innerHTML = b.content;
                    div.querySelectorAll('img').forEach(img => { const src = img.getAttribute('src'); if(src && src.includes(folderName)) usedFiles.add(src.split('/').pop()); });
                });
                const imgDir = await this.dirHandle.getDirectoryHandle(folderName);
                for await (const [name, handle] of imgDir.entries()) { if (!usedFiles.has(name)) { await imgDir.removeEntry(name); console.log("ğŸ—‘ï¸ ë¯¸ì‚¬ìš© ì´ë¯¸ì§€ ì‚­ì œë¨:", name); } }
            } catch (e) { console.error("ì²­ì†Œ ì¤‘ ì˜¤ë¥˜:", e); }
        }
    };

    async function saveProjectJSON() {
        if (!FileSystem.dirHandle) { if(!confirm("âš ï¸ ë¡œì»¬ í´ë”ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n(ì´ë¯¸ì§€ ì²­ì†Œ ë° ì§ì ‘ ì €ì¥ì´ ë¶ˆê°€ëŠ¥í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ë©ë‹ˆë‹¤.)")) return; }
        showLoading("ğŸ’¾ ì •ë¦¬ ë° ì €ì¥ ì¤‘...");
        
        ManualRenderer.syncAllBlocks();

        const rawData = JSON.parse(JSON.stringify(docData)); 
        rawData.blocks.forEach(block => {
            if (block.content.includes('<img')) {
                const div = document.createElement('div'); div.innerHTML = block.content;
                div.querySelectorAll('img').forEach(img => { if (img.dataset.path) img.src = img.dataset.path; });
                block.content = div.innerHTML;
            }
        });
        if (FileSystem.dirHandle) await FileSystem.cleanUpImages(rawData.blocks);
        if (FileSystem.dirHandle) {
            try {
                const fileHandle = await FileSystem.dirHandle.getFileHandle('data.json', { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(JSON.stringify(rawData, null, 2));
                await writable.close();
                hideLoading(); alert("âœ… 'data.json'ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch(e) { alert("ì €ì¥ ì˜¤ë¥˜: " + e.message); hideLoading(); }
        } else {
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(rawData, null, 2)], {type:'application/json'})); a.download = 'exam_v2.8.json'; a.click(); hideLoading();
        }
    }

    function handleGlobalDblClick(e) {
        const blank = e.target.closest('.blank-box');
        if (blank) {
            e.preventDefault(); e.stopPropagation();
            const text = blank.innerText;
            const textNode = document.createTextNode(`[ë¹ˆì¹¸:${text}]`);
            blank.parentNode.replaceChild(textNode, blank);
        }
        const placeholder = e.target.closest('.image-placeholder');
        if (placeholder) {
            e.preventDefault(); e.stopPropagation();
            if(selectedPlaceholder) selectedPlaceholder.classList.remove('selected');
            selectedPlaceholder = placeholder; 
            placeholder.classList.add('selected'); 
            placeholder.setAttribute('contenteditable', 'false');
            document.getElementById('imgUpload').click();
        }
    }

    const ImportParser = {
        parse(text) {
            const blocks = []; const rawItems = text.split('[[').filter(s => s.trim().length > 0);
            rawItems.forEach(chunk => {
                const closeIdx = chunk.indexOf(']]'); if (closeIdx === -1) return;
                const meta = chunk.substring(0, closeIdx); let content = chunk.substring(closeIdx + 2).trim();
                if (content.startsWith(':')) content = content.substring(1).trim();
                content = content.replace(/\[ì´ë¯¸ì§€:(.*?)\]/g, '<span class="image-placeholder">[ì´ë¯¸ì§€: $1]</span>');
                content = content.replace(/\[ë¹ˆì¹¸:(.*?)\]/g, '<span class="blank-box" contenteditable="false">$1</span>');
                content = content.replace(/\n/g, '<br>');
                const [stylePart, labelPart] = meta.includes('_') ? meta.split('_') : ['ê¸°ë³¸', meta];
                const styles = stylePart.split(',');
                let type = 'example'; let bordered = styles.includes('ë°•ìŠ¤'); let bgGray = styles.includes('ìŒì˜');
                let label = labelPart ? `<span class="q-label">${labelPart}</span>` : '';
                if (styles.includes('ê°œë…')) type = 'concept';
                blocks.push({ id: 'imp_' + Date.now() + Math.random(), type: type, content: label + ' ' + content, bordered: bordered, bgGray: bgGray });
            });
            return blocks;
        }
    };

    function confirmImport(overwrite) {
        const input = document.getElementById('import-textarea').value.trim(); if(!input) return;
        const limit = parseInt(document.getElementById('setting-limit').value) || 0; const addSpacer = document.getElementById('setting-spacer').checked;
        let finalBlocks = [];
        try {
            if (input.startsWith('[') || input.startsWith('{')) {
                const json = JSON.parse(input); const arr = Array.isArray(json) ? json : [json];
                finalBlocks = arr.map(item => ({ id: 'imp_json_' + Date.now() + Math.random(), type: item.type || 'example', content: item.content || '', bordered: item.bordered || false, bgGray: item.bgGray || false }));
            } else if (input.includes('<div') && input.includes('data-item')) {
                const parser = new DOMParser(); const doc = parser.parseFromString(input, 'text/html'); const items = doc.querySelectorAll('.data-item');
                items.forEach(i => { let t = 'example', c = i.innerHTML; if(i.querySelector('.concept-box')) { t = 'concept'; c = i.querySelector('.concept-box').innerHTML; } else if(i.querySelector('.answer-area')) { t = 'answer'; c = i.querySelector('.answer-area').innerHTML; } finalBlocks.push({ id: 'imp_html_' + Date.now() + Math.random(), type: t, content: c }); });
            } else { finalBlocks = ImportParser.parse(input); }

            let processedBlocks = []; let countInColumn = 0;
            finalBlocks.forEach((b, idx) => { processedBlocks.push(b); if(b.type !== 'answer') { countInColumn++; if(addSpacer) processedBlocks.push({id:'sp_'+Math.random(), type:'spacer', height:50}); } if (limit > 0 && countInColumn >= limit && idx < finalBlocks.length - 1) { processedBlocks.push({id:'br_'+Math.random(), type:'break'}); countInColumn = 0; } });

            if(overwrite) docData.blocks = processedBlocks; else docData.blocks = docData.blocks.concat(processedBlocks);
            closeModal('import-modal'); renderPages(); saveHistory();
        } catch(e) { alert("ë°ì´í„° ì¸ì‹ ì‹¤íŒ¨: "+e.message); }
    }

    window.onload = () => {
        const saved = localStorage.getItem('editorAutoSave'); if(saved) { docData = JSON.parse(saved); } 
        renderPages(); saveHistory();

        document.getElementById('zoomRange').addEventListener('input', (e) => { document.getElementById('paper-container').style.transform = `scale(${e.target.value})`; docData.meta.zoom = parseFloat(e.target.value); hideResizer(); hideToolbar(); });
        const body = document.body;
        body.addEventListener('dragover', (e) => { e.preventDefault(); if(e.dataTransfer.types.includes('Files')) body.classList.add('drag-over'); });
        body.addEventListener('dragleave', () => body.classList.remove('drag-over'));
        body.addEventListener('drop', (e) => {
            e.preventDefault(); body.classList.remove('drag-over'); const file = e.dataTransfer.files[0];
            if(file) {
                if(file.name.endsWith('.json')) { const r = new FileReader(); r.onload = (evt) => { docData = JSON.parse(evt.target.result); renderPages(); saveHistory(); }; r.readAsText(file); } 
                else if(file.name.endsWith('.txt')) { const r = new FileReader(); r.onload = (evt) => { openModal('import-modal'); document.getElementById('import-textarea').value = evt.target.result; }; r.readAsText(file); }
            }
        });
        document.getElementById('imgUpload').addEventListener('change', handleImageUpload);
        document.addEventListener('paste', handleGlobalPaste);
        document.addEventListener('mousedown', handleClickOutside);
        document.addEventListener('dblclick', handleGlobalDblClick);
        document.addEventListener('keydown', handleGlobalKeydown);
        document.querySelector('.rh-se').addEventListener('mousedown', initResizeImage);
    };

    function handleClickOutside(e) {
        if (!e.target.closest('#floating-toolbar') && !e.target.closest('.ft-btn')) hideToolbar();
        if (!e.target.closest('img') && !e.target.closest('#image-resizer')) hideResizer();
        if (!e.target.closest('#context-menu')) document.getElementById('context-menu').style.display = 'none';
        if (!e.target.classList.contains('image-placeholder')) {
            if(selectedPlaceholder) { selectedPlaceholder.classList.remove('selected'); selectedPlaceholder.setAttribute('contenteditable', 'false'); } selectedPlaceholder = null;
        }
        setTimeout(() => {
            const sel = window.getSelection();
            if (sel.rangeCount && !sel.isCollapsed) {
                const range = sel.getRangeAt(0); const container = range.commonAncestorContainer.nodeType===1 ? range.commonAncestorContainer : range.commonAncestorContainer.parentNode;
                if (container.closest('.editable-box')) {
                    const rect = range.getBoundingClientRect(); const tb = document.getElementById('floating-toolbar');
                    tb.style.display = 'flex'; tb.style.top = (rect.top + window.scrollY - 45) + 'px'; tb.style.left = (rect.left + window.scrollX + rect.width / 2) + 'px';
                }
            }
        }, 10);
    }

    function handleGlobalKeydown(e) {
        keysPressed[e.key.toLowerCase()] = true;
        if (keysPressed['control'] && keysPressed['q'] && keysPressed['f']) { e.preventDefault(); openModal('find-replace-modal'); document.getElementById('fr-find-input').focus(); keysPressed['f'] = false; return; }
        if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveProjectJSON(); return; }
        
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'z' || e.key === 'Z')) { e.preventDefault(); performRedo(); return; }
        else if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'Z')) { e.preventDefault(); performUndo(); return; }

        if (e.key === 'Backspace') {
            if (selectedPlaceholder && selectedPlaceholder.getAttribute('contenteditable') === 'false') { e.preventDefault(); const wrapper = selectedPlaceholder.closest('.block-wrapper'); if(wrapper) deleteBlockById(wrapper.dataset.id); } 
            else if (selectedImage) { e.preventDefault(); selectedImage.remove(); hideResizer(); saveHistoryDebounced(); }
        }
    }

    async function handleGlobalPaste(e) {
        let target = null;
        if (selectedPlaceholder && selectedPlaceholder.getAttribute('contenteditable') === 'false') target = selectedPlaceholder; 
        else {
            const sel = window.getSelection();
            if (sel.rangeCount) { const node = sel.anchorNode; const el = node.nodeType === 1 ? node : node.parentElement; if (el.closest('.editable-box')) target = 'cursor'; }
        }
        if (!target) return;
        const items = (e.clipboardData || e.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file' && item.type.includes('image/')) {
                e.preventDefault(); const file = item.getAsFile(); showLoading("ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥ ì¤‘...");
                const saved = await FileSystem.saveImage(file); hideLoading(); if (!saved) return; 
                const newImg = document.createElement('img'); newImg.src = saved.url; newImg.dataset.path = saved.path; newImg.style.maxWidth = '100%';
                if (target === selectedPlaceholder) { target.replaceWith(newImg); updateBlockContent(newImg.closest('.block-wrapper').dataset.id, newImg.closest('.editable-box').innerHTML); selectedPlaceholder = null; } 
                else if (target === 'cursor') { document.execCommand('insertHTML', false, newImg.outerHTML); }
                saveHistoryDebounced(); return;
            }
        }
    }

    function loadProjectJSON(input) {
        const file = input.files[0]; if(!file) return; const r = new FileReader();
        r.onload = async (e) => {
            docData = JSON.parse(e.target.result);
            if (FileSystem.dirHandle) await FileSystem.loadImagesForDisplay(docData.blocks);
            else alert("âš ï¸ ë¡œì»¬ í´ë”ê°€ ì—°ê²°ë˜ì§€ ì•Šì•„ ì´ë¯¸ì§€ê°€ ë³´ì´ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
            renderPages(); saveHistory();
        }; r.readAsText(file);
    }

    function showLoading(msg) { const el=document.getElementById('loading-indicator'); el.innerText=msg; el.style.display='block'; }
    function hideLoading() { document.getElementById('loading-indicator').style.display='none'; }
    function saveHistory() { const str=JSON.stringify(docData); if(historyIndex>=0 && historyStack[historyIndex]===str)return; historyIndex++; historyStack=historyStack.slice(0,historyIndex); historyStack.push(str); if(historyStack.length>30){ historyStack.shift(); historyIndex--; } localStorage.setItem('editorAutoSave',str); }
    function saveHistoryDebounced() { clearTimeout(renderTimer); renderTimer=setTimeout(saveHistory,500); }
    function performUndo() { if(historyIndex>0){ historyIndex--; docData=JSON.parse(historyStack[historyIndex]); renderPages(); } }
    function performRedo() { if(historyIndex<historyStack.length-1){ historyIndex++; docData=JSON.parse(historyStack[historyIndex]); renderPages(); } }
    
    function createPage(num) {
        const div=document.createElement('div'); div.className='page'; if(num===1) div.classList.add('page-first');
        const headerHTML = num === 1 ? 
            `<table class="header-table">
                <colgroup><col class="col-title"><col class="col-label"><col class="col-input-wide"><col class="col-label"><col class="col-input-narrow"></colgroup>
                <tr><td rowspan="2" class="col-title">TEST</td><td class="col-label">ê³¼ì •</td><td><input class="header-input" value="${docData.meta.title}" oninput="docData.meta.title=this.value;saveHistoryDebounced()"></td><td class="col-label">ì„±ëª…</td><td><input class="header-input"></td></tr>
                <tr><td class="col-label">ë‹¨ì›</td><td><input class="header-input" value="${docData.meta.subtitle}" oninput="docData.meta.subtitle=this.value;saveHistoryDebounced()"></td><td class="col-label">ì ìˆ˜</td><td></td></tr>
            </table>` : `<div class="header-line"></div>`;
        const footerHTML = num === 1 ? `<div class="footer-content-first">- ${num} -</div>` : `<div class="footer-line"></div><div>- ${num} -</div>`;
        div.innerHTML=`<div class="header-area">${headerHTML}</div><div class="body-container"><div class="column left"></div><div class="column right"></div></div><div class="page-footer">${footerHTML}</div>`;
        return div;
    }

    function renderPages() { 
        const container = document.getElementById('paper-container'); container.innerHTML = ''; 
        let pageNum=1, currentPage=createPage(pageNum); let colL=currentPage.querySelector('.left'), colR=currentPage.querySelector('.right'), curCol=colL; container.appendChild(currentPage); 
        docData.blocks.forEach((block) => { 
            if (block.type === 'break') { curCol.appendChild(createBlock(block)); if(curCol===colL) curCol=colR; else { pageNum++; currentPage=createPage(pageNum); container.appendChild(currentPage); colL=currentPage.querySelector('.left'); colR=currentPage.querySelector('.right'); curCol=colL; } return; } 
            const el = createBlock(block); curCol.appendChild(el); 
            if (curCol.scrollHeight > curCol.clientHeight + 5) { curCol.removeChild(el); if(curCol===colL) curCol=colR; else { pageNum++; currentPage=createPage(pageNum); container.appendChild(currentPage); colL=currentPage.querySelector('.left'); colR=currentPage.querySelector('.right'); curCol=colL; } curCol.appendChild(el); } 
        });
        
        if(lastFocusId) {
            setTimeout(() => {
                const el = document.querySelector(`.block-wrapper[data-id="${lastFocusId}"] .editable-box`);
                if(el) { el.focus(); const range=document.createRange(); range.selectNodeContents(el); range.collapse(false); const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(range); lastFocusId=null; }
            }, 0);
        }
    }

    function insertImageBoxSafe() {
        if(document.activeElement && document.activeElement.isContentEditable) { insertImageBox(); } else { addBlockBelow('image'); }
    }

    function isCaretOnLastLine(element) {
        const selection = window.getSelection(); if (selection.rangeCount === 0) return false;
        const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect(); const elementRect = element.getBoundingClientRect();
        return (elementRect.bottom - rect.bottom) < 30; 
    }
    function isCaretOnFirstLine(element) {
        const selection = window.getSelection(); if (selection.rangeCount === 0) return false;
        const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect(); const elementRect = element.getBoundingClientRect();
        return (rect.top - elementRect.top) < 30;
    }
    function focusNextBlock(currentId, direction) {
        const idx = docData.blocks.findIndex(b => b.id === currentId);
        let nextIdx = idx + direction;
        while(nextIdx >= 0 && nextIdx < docData.blocks.length) {
            const nextBlock = docData.blocks[nextIdx];
            if (['concept', 'example'].includes(nextBlock.type)) {
                const nextEl = document.querySelector(`.block-wrapper[data-id="${nextBlock.id}"] .editable-box`);
                if(nextEl) {
                    nextEl.focus(); const nextWrap = nextEl.closest('.block-wrapper');
                    nextWrap.classList.add('temp-show-handle'); setTimeout(() => nextWrap.classList.remove('temp-show-handle'), 1000);
                }
                return;
            }
            nextIdx += direction;
        }
    }

    function createBlock(block) {
        const wrap=document.createElement('div'); wrap.className='block-wrapper'; wrap.dataset.id=block.id;
        if(block.style && block.style.textAlign) wrap.style.textAlign = block.style.textAlign;
        if(block.bgGray) wrap.classList.add('bg-gray-block');

        // [Fix 2] ë“œë˜ê·¸ ì¡°ê±´ ì™„í™” (closest ì‚¬ìš©)
        wrap.draggable=true;
        wrap.ondragstart=(e)=>{ 
            if(!e.target.closest('.block-handle')) { e.preventDefault(); return; } 
            dragSrcId=block.id; wrap.classList.add('dragging'); 
        };
        wrap.ondragover=(e)=>{ e.preventDefault(); const r=wrap.getBoundingClientRect(); wrap.classList.remove('drop-target-top','drop-target-bottom'); if((e.clientY-r.top)<(r.height/2)) wrap.classList.add('drop-target-top'); else wrap.classList.add('drop-target-bottom'); };
        wrap.ondrop=(e)=>{ e.stopPropagation(); e.preventDefault(); if(dragSrcId && dragSrcId!==block.id){ const srcIdx=docData.blocks.findIndex(b=>b.id===dragSrcId); const tgtIdx=docData.blocks.findIndex(b=>b.id===block.id); const [moved]=docData.blocks.splice(srcIdx,1); if(wrap.classList.contains('drop-target-bottom')) docData.blocks.splice(tgtIdx+1,0,moved); else docData.blocks.splice(tgtIdx,0,moved); renderPages(); saveHistory(); } document.querySelectorAll('.block-wrapper').forEach(w=>w.classList.remove('dragging','drop-target-top','drop-target-bottom')); };

        const handle=document.createElement('div'); handle.className='block-handle';
        handle.onclick=(e)=>{ e.stopPropagation(); contextTargetId=block.id; const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.clientX+'px'; m.style.top=e.clientY+'px'; };
        wrap.appendChild(handle);

        if(block.type==='break'){
            const br=document.createElement('div'); br.className='break-line'; br.onclick=()=>{if(confirm("ë‹¨ ë‚˜ëˆ„ê¸° ì‚­ì œ?"))deleteBlockById(block.id);}; wrap.appendChild(br);
        } else if(block.type==='spacer'){
            const sp=document.createElement('div'); sp.className='spacer-block'; sp.style.height=(block.height||50)+'px';
            sp.onmousedown=(e)=>{ const sY=e.clientY, sH=parseInt(sp.style.height); const mv=(ev)=>{ const nH=Math.max(10, sH+(ev.clientY-sY)); sp.style.height=nH+'px'; block.height=nH; }; window.addEventListener('mousemove',mv); window.addEventListener('mouseup',()=>{window.removeEventListener('mousemove',mv); saveHistory();},{once:true}); }; wrap.appendChild(sp);
        } else {
            const box=document.createElement('div'); box.className=`editable-box ${block.type}-box`;
            if(block.type==='concept') box.classList.add('concept-box');
            if(block.bordered) box.classList.add('bordered-box');
            box.innerHTML=block.content;
            box.contentEditable=true;
            
            box.oninput=()=>{ updateBlockContent(block.id, box.innerHTML, true); };
            
            box.addEventListener('mousedown', (e) => {
                if(e.target.tagName==='IMG') { showResizer(e.target); e.stopPropagation(); selectedImage=e.target; }
                if(e.target.classList.contains('image-placeholder')) {
                    e.stopPropagation(); if(selectedPlaceholder) selectedPlaceholder.classList.remove('selected');
                    selectedPlaceholder = e.target; selectedPlaceholder.classList.add('selected'); selectedPlaceholder.setAttribute('contenteditable', 'false');
                }
            });
            
            box.onkeydown = (e) => {
                if(e.key === 'Tab') { 
                    e.preventDefault(); 
                    if(e.shiftKey) document.execCommand('insertHTML', false, '&nbsp;'.repeat(10));
                    else if(e.ctrlKey) focusNextBlock(block.id, -1);
                    else focusNextBlock(block.id, 1);
                    return; 
                }
                
                if(e.key === 'ArrowDown') { if (isCaretOnLastLine(box)) { e.preventDefault(); focusNextBlock(block.id, 1); } }
                if(e.key === 'ArrowUp') { if (isCaretOnFirstLine(box)) { e.preventDefault(); focusNextBlock(block.id, -1); } }
                
                if(e.key === 'Enter') {
                    if(e.ctrlKey) { e.preventDefault(); contextTargetId = block.id; addBlockBelow('break'); return; }
                    if(e.altKey) { e.preventDefault(); contextTargetId = block.id; addBlockAbove('example'); return; }
                    if(e.shiftKey) return; 
                    e.preventDefault(); contextTargetId = block.id; addBlockBelow('example'); 
                }

                if(e.key === 'Backspace') { 
                    if(box.innerText.trim() === '' && box.innerHTML.replace(/<br>/g,'').trim() === '') { 
                        const prevIdx = docData.blocks.findIndex(b=>b.id===block.id) - 1; 
                        if (prevIdx >= 0) { e.preventDefault(); deleteBlockById(block.id); lastFocusId = docData.blocks[prevIdx].id; renderPages(); } 
                    } 
                }
                
                if((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'l' || e.key === 'L')) { e.preventDefault(); contextTargetId=block.id; applyAlign('left'); return; }
                if((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'r' || e.key === 'R')) { e.preventDefault(); contextTargetId=block.id; applyAlign('right'); return; }
                if((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'm' || e.key === 'M')) { e.preventDefault(); contextTargetId=block.id; applyAlign('center'); return; }
                if((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'i' || e.key === 'I')) { e.preventDefault(); insertImageBox(); return; }
            };

            wrap.appendChild(box);
        }
        return wrap;
    }

    function updateBlockContent(id, html, recordHistory=true) { 
        const b = docData.blocks.find(x=>x.id===id); 
        if(b) b.content=html; 
        if(recordHistory) saveHistoryDebounced(); 
    }
    function deleteBlockById(id) { docData.blocks = docData.blocks.filter(b=>b.id!==id); renderPages(); saveHistory(); }
    function duplicateTargetBlock() { if(!contextTargetId) return; const idx = docData.blocks.findIndex(b=>b.id===contextTargetId); const clone = JSON.parse(JSON.stringify(docData.blocks[idx])); clone.id = 'copy_'+Date.now(); docData.blocks.splice(idx+1, 0, clone); renderPages(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    function addBlockBelow(type) { let targetIdx = contextTargetId ? docData.blocks.findIndex(b=>b.id===contextTargetId) : docData.blocks.length-1; const newBlock = createNewBlockData(type); docData.blocks.splice(targetIdx+1, 0, newBlock); if(type!=='break') lastFocusId = newBlock.id; renderPages(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    function addBlockAbove(type) { if(!contextTargetId) return; let targetIdx = docData.blocks.findIndex(b=>b.id===contextTargetId); const newBlock = createNewBlockData(type); docData.blocks.splice(targetIdx, 0, newBlock); lastFocusId = newBlock.id; renderPages(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    
    // [Fix 3] ìƒˆ ë¸”ë¡ ìƒì„± ì‹œ ë¼ë²¨ ìë™ ì‚½ì… ì œê±° (ê¹¨ë—í•œ ë¹ˆ ì¤„ ìƒì„±)
    function createNewBlockData(type) { 
        const newBlock = { id:'b_'+Date.now(), type:type, content:'' }; 
        if(type==='concept') newBlock.content='<span class="q-label">ê°œë…</span> '; 
        // if(type==='example') newBlock.content='<span class="q-label">ì˜ˆì œ</span> '; // ì‚­ì œë¨: ì´ì œ ê¸°ë³¸ì€ ë¹ˆ ì¤„
        if(type==='image') { newBlock.type='example'; newBlock.content='<span class="image-placeholder" contenteditable="false">ì´ë¯¸ì§€ ë°•ìŠ¤ (Click to Select)</span>'; }
        if(type==='break') newBlock.type='break'; 
        if(type==='spacer') { newBlock.type='spacer'; newBlock.height=50; } 
        return newBlock; 
    }
    
    function deleteTargetBlock() { if(contextTargetId) deleteBlockById(contextTargetId); document.getElementById('context-menu').style.display='none'; }
    function applyAlign(align) { const b = docData.blocks.find(x=>x.id===contextTargetId); if(b) { if(!b.style) b.style={}; b.style.textAlign=align; } renderPages(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    function toggleGrayBg() { const b = docData.blocks.find(x=>x.id===contextTargetId); if(b) b.bgGray = !b.bgGray; renderPages(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    function toggleBorder() { const b = docData.blocks.find(x=>x.id===contextTargetId); if(b) b.bordered = !b.bordered; renderPages(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    function insertImageBox() { document.execCommand('insertHTML', false, `<span class="image-placeholder" contenteditable="false">ì´ë¯¸ì§€ ë°•ìŠ¤ (Click to Select)</span>`); document.getElementById('context-menu').style.display='none'; }
    function execStyle(cmd, val=null) { document.execCommand(cmd, false, val); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function executeFindReplace() { const findStr = document.getElementById('fr-find-input').value; const repStr = document.getElementById('fr-replace-input').value; if (!findStr) return; docData.blocks.forEach(block => { block.content = block.content.replaceAll(findStr, repStr); }); renderPages(); saveHistory(); closeModal('find-replace-modal'); }
    function showResizer(img) { selectedImage = img; const resizer = document.getElementById('image-resizer'); const rect = img.getBoundingClientRect(); resizer.style.display = 'block'; resizer.style.top = (rect.top + window.scrollY) + 'px'; resizer.style.left = (rect.left + window.scrollX) + 'px'; resizer.style.width = rect.width + 'px'; resizer.style.height = rect.height + 'px'; }
    function hideResizer() { document.getElementById('image-resizer').style.display = 'none'; selectedImage = null; }
    function hideToolbar() { document.getElementById('floating-toolbar').style.display = 'none'; }
    function initResizeImage(e) { e.preventDefault(); e.stopPropagation(); if(!selectedImage) return; const startX = e.clientX, startY = e.clientY; const startW = selectedImage.offsetWidth, startH = selectedImage.offsetHeight; const zoom = docData.meta.zoom || 1.0; function doDrag(evt) { const newW = Math.max(20, startW + (evt.clientX - startX) / zoom); const newH = Math.max(20, startH + (evt.clientY - startY) / zoom); selectedImage.style.width = newW + 'px'; selectedImage.style.height = newH + 'px'; showResizer(selectedImage); } function stopDrag() { window.removeEventListener('mousemove', doDrag); window.removeEventListener('mouseup', stopDrag); updateBlockContent(selectedImage.closest('.block-wrapper').dataset.id, selectedImage.closest('.editable-box').innerHTML); } window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', stopDrag); }
    function handleImageUpload(e) { 
        if(!selectedPlaceholder || !e.target.files[0]) return;
        const file = e.target.files[0];
        if(FileSystem.dirHandle) {
            FileSystem.saveImage(file).then(saved => {
                if(saved) {
                    const newImg = document.createElement('img'); newImg.src = saved.url; newImg.dataset.path = saved.path; newImg.style.maxWidth = '100%';
                    selectedPlaceholder.replaceWith(newImg); updateBlockContent(newImg.closest('.block-wrapper').dataset.id, newImg.closest('.editable-box').innerHTML); selectedPlaceholder = null;
                }
            });
        } else {
            const r=new FileReader(); r.onload=(evt)=>{ 
                const newImg = document.createElement('img'); newImg.src = evt.target.result; newImg.style.maxWidth = '100%';
                selectedPlaceholder.replaceWith(newImg); updateBlockContent(newImg.closest('.block-wrapper').dataset.id, newImg.closest('.editable-box').innerHTML); selectedPlaceholder = null;
            }; r.readAsDataURL(file);
        }
        e.target.value='';
    }
    function resetProject(){ if(confirm('ì´ˆê¸°í™”?')) { docData.blocks=[]; renderPages(); saveHistory(); } }
    async function printWithMath(){ showLoading("ğŸ–¨ï¸ ì¸ì‡„ ì¤€ë¹„ ì¤‘..."); window.print(); hideLoading(); }
</script>
</body>
</html>
