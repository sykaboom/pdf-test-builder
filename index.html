<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Math Exam Editor v3.9.5 (Fixed & UX Improved)</title>
    <script>
        // [ì„¤ì •] MathJax (v3.8: ìµœì í™” ìœ ì§€)
        window.MathJax = {
            tex: { 
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: true,
                packages: ['base', 'ams', 'noerrors', 'noundefined']
            },
            svg: { 
                fontCache: 'none', 
                scale: 1.0, 
                displayAlign: 'left',
                internalSpeechTitles: false 
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process',
                renderActions: {
                    assistiveMml: [] // ë³´ì¡° í…ìŠ¤íŠ¸ ì°¨ë‹¨ (ìˆ˜ì‹ ì¤‘ë³µ ë°©ì§€)
                }
            },
            startup: { 
                typeset: false,
                pageReady: () => {
                    return MathJax.startup.defaultPageReady().then(() => {
                        console.log('MathJax Engine Ready');
                        window.isMathJaxReady = true;
                    });
                }
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* [ê¸°ë³¸ ì„¤ì •] */
        * { box-sizing: border-box; outline: none; }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; display: flex; font-family: 'Noto Sans KR', sans-serif; background-color: #525659; }

        /* [ìˆ˜ì‹ Atom ìŠ¤íƒ€ì¼] */
        mjx-container { 
            display: inline-block !important; vertical-align: middle !important; margin: 0 2px; 
            cursor: pointer; user-select: none; color: inherit !important;
        }
        mjx-assistive-mml { display: none !important; }

        /* [ì¸ì‡„ êµµê¸° ë³´ì •] */
        mjx-container svg path, mjx-container svg rect, mjx-container svg polygon {
            fill: currentColor !important; stroke: none !important; stroke-width: 0 !important;
        }
        mjx-container:hover { background-color: rgba(0, 0, 0, 0.05); border-radius: 4px; }
        mjx-container:focus { outline: 2px solid #007bff; border-radius: 4px; }

        /* [ë¹ˆì¹¸ ë°•ìŠ¤ ìŠ¤íƒ€ì¼] */
        .blank-box {
            display: inline-block; border: 1px solid #333; padding: 1px 10px; margin: 0 2px;
            min-width: 36px; text-align: center; font-weight: bold; background: #fff;
            font-family: 'Noto Sans KR', sans-serif; font-size: 0.95em; vertical-align: middle;
            cursor: pointer; border-radius: 2px; user-select: none;
        }
        .blank-box:hover { background-color: #f8f9fa; border-color: #007bff; color: #007bff; }

        /* [UI ìŠ¤íƒ€ì¼] */
        #drop-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 123, 255, 0.85); z-index: 9999; display: none; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; pointer-events: none; flex-direction: column; gap: 10px; }
        /* [Fix v3.8] body.drag-over í´ë˜ìŠ¤ê°€ ìˆì„ ë•Œë§Œ ì˜¤ë²„ë ˆì´ í‘œì‹œ */
        body.drag-over #drop-overlay { display: flex; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 700px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); display: flex; flex-direction: column; gap: 15px; }
        .modal-textarea { width: 100%; height: 250px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-family: monospace; font-size: 12px; resize: none; background: #f8f9fa; color: #333; }

        /* [ì°¾ê¸°/ë°”ê¾¸ê¸° ëª¨ë‹¬] */
        #find-replace-modal .modal-content { width: 400px; padding: 20px; gap: 10px; }
        .fr-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .fr-label { width: 80px; font-size: 13px; font-weight: bold; color: #333; }
        .fr-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
        .fr-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }

        /* [ë ˆì´ì•„ì›ƒ] */
        .sidebar { width: 340px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; padding: 15px; z-index: 200; flex-shrink: 0; overflow-y: auto; }
        .workspace { flex-grow: 1; overflow: auto; display: flex; flex-direction: column; align-items: center; padding: 40px 0; background-color: #525659; }
        
        #loading-indicator { position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.85); color: #fff; padding: 10px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; display: none; z-index: 11000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; transform: scale(1.02); } 100% { opacity: 0.8; } }

        /* [í˜ì´ì§€] */
        .page { 
            width: 210mm; height: 297mm; padding: 15mm 10mm; 
            background: white; color: black; position: relative; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); margin-bottom: 30px; 
            display: flex; flex-direction: column; flex-shrink: 0; 
            overflow: visible; 
            transform-origin: top center; transition: transform 0.1s; 
        }
        
        .header-area { width: 100%; margin-bottom: 10px; flex-shrink: 0; }
        .header-table { width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 10pt; table-layout: fixed; }
        .header-table td { border: 1px solid #000; padding: 5px; text-align: center; height: 35px; vertical-align: middle; }
        .col-title { width: 15%; background-color: #f0f0f0; font-weight: bold; }
        .col-label { width: 10%; background-color: #f0f0f0; font-weight: bold; }
        .col-input-wide { width: 45%; }
        .col-input-narrow { width: 20%; }
        .header-input, .footer-input { width: 100%; border: none; text-align: center; font-family: inherit; font-size: inherit; background: transparent; }
        .header-line { width: 100%; border-bottom: 1px solid #000; height: 1px; margin-bottom: 10px; }
        .page-footer { flex-shrink: 0; margin-top: auto; width: 100%; z-index: 10; background: white; text-align: center; font-size: 10pt; }
        .footer-content-first { border-top: 1px solid #000; padding-top: 5px; }
        .footer-line { width: 100%; border-top: 1px solid #000; height: 1px; margin-bottom: 5px; }
        .body-container { flex-grow: 1; display: flex; position: relative; width: 100%; align-items: flex-start; }
        .body-container::after { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 0; border-left: 1px solid #000; transform: translateX(-0.5px); z-index: 0; }
        .column { width: 50%; height: 100%; display: flex; flex-direction: column; padding-right: 5mm; z-index: 1; }
        .column.right { padding-right: 0; padding-left: 5mm; }

        /* [ë¸”ë¡ ìš”ì†Œ] */
        .block-wrapper { 
            position: relative; margin-bottom: 2px; width: 100%; flex-shrink: 0; 
            border-radius: 4px; border: 1px solid transparent; transition: background 0.1s;
            padding-right: 0; 
            overflow: visible; 
        }
        .block-wrapper:hover { background-color: rgba(0,0,0,0.03); }
        .block-wrapper.bg-gray-block { background-color: #f1f3f5; border-radius: 6px; padding: 5px; margin-bottom: 5px; border: 1px solid #e9ecef; }
        
        /* [Fix: í•¸ë“¤] */
        .block-handle { 
            position: absolute; left: -24px; top: 0; width: 24px; height: 100%; 
            cursor: grab; display: flex; align-items: flex-start; padding-top: 6px; 
            justify-content: center; opacity: 0; color: #bbb; z-index: 150; 
            transition: opacity 0.2s; user-select: none;
        }
        .block-wrapper:hover .block-handle { opacity: 1; }
        .block-handle::after { content: 'â‰¡'; font-size: 18px; line-height: 1; font-weight: bold; }
        .block-handle:active { cursor: grabbing; color: #555; }
        
        /* [Fix v3.8] ìš°ì¸¡ ì•¡ì…˜ ë²„íŠ¼: ë³¸ë¬¸ ë°”ê¹¥ìœ¼ë¡œ ì´ë™ & ëŠê¹€ ë°©ì§€ ì²˜ë¦¬ */
        .block-actions { 
            position: absolute; 
            right: -30px; 
            top: 2px; 
            display: flex; flex-direction: column; gap: 2px; 
            opacity: 0; transition: opacity 0.2s; z-index: 100; pointer-events: none; 
        }
        .block-actions::before {
            content: ''; position: absolute; 
            top: 0; bottom: 0; right: 100%; 
            width: 30px; 
            background: transparent;
        }
        .block-wrapper:hover .block-actions { opacity: 1; pointer-events: auto; }
        
        .block-action-btn { width: 22px; height: 22px; border: 1px solid #ddd; border-radius: 3px; background: #fff; font-size: 12px; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; color: #777; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .block-action-btn:hover { background: #007bff; color: white; border-color: #007bff; }

        .block-wrapper.dragging { opacity: 0.4; background: #e2e6ea; }
        .drop-target-top { border-top: 3px solid #007bff; margin-top: -3px; }
        .drop-target-bottom { border-bottom: 3px solid #007bff; margin-bottom: -3px; }

        .editable-box { 
            border-radius: 4px; padding: 2px 2px;
            font-family: 'Noto Serif KR', serif; font-size: 10.5pt; line-height: 1.6; 
            text-align: inherit; word-break: break-all; min-height: 28px; width: 100%; cursor: text;
        }
        .editable-box.bordered-box { border: 1px solid #333; padding: 8px 10px; border-radius: 6px; background: #fff; }
        .editable-box img { max-width: 100%; cursor: pointer; } 
        .editable-box img[src=""]::before { content: 'âŒ ì´ë¯¸ì§€ ì—†ìŒ'; color: red; border: 1px dashed red; padding: 10px; display: block; }

        .concept-box { border: 1px solid #333; border-radius: 6px; background: #fff; padding: 8px 10px; margin-bottom: 5px; width: 100%; }
        .q-label { color: #1a6fc0; font-weight: 800; font-family: 'Noto Sans KR', sans-serif; margin-right: 5px; }

        .spacer-block { width: 100%; background: repeating-linear-gradient(45deg, #f9f9f9, #f9f9f9 10px, #fff 10px, #fff 20px); border: 1px dashed #ddd; cursor: ns-resize; display: flex; align-items: center; justify-content: center; margin: 5px 0; }
        .break-line { height: 24px; border-bottom: 2px dotted #ff4444; margin: 5px 0 15px 0; text-align: center; color: #ff4444; font-size: 11px; cursor: pointer; background: rgba(255, 200, 200, 0.1); }
        .break-line:hover::after { content: ' (í´ë¦­í•˜ì—¬ ì‚­ì œ)'; }

        .image-placeholder { display: inline-block; width: 100%; padding: 20px; border: 2px dashed #007bff; background-color: #f0f7ff; color: #0056b3; text-align: center; cursor: pointer; font-size: 12px; border-radius: 6px; font-weight: bold; user-select: none; }
        .image-placeholder.selected { border: 2px solid #0056b3; background-color: #dbeafe; box-shadow: 0 0 0 3px rgba(0,123,255,0.25); outline: none; }

        /* [íˆ´ë°”] */
        #floating-toolbar { position: absolute; background: #333; border-radius: 6px; padding: 5px; display: none; gap: 5px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transform: translate(-50%, -120%); }
        #floating-toolbar::after { content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .ft-btn { background: transparent; border: none; color: white; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 14px; font-weight: bold; }
        .ft-btn:hover { background: rgba(255,255,255,0.2); }
        .ft-sep { width: 1px; background: rgba(255,255,255,0.3); margin: 0 2px; height: 20px; align-self: center; }

        #image-resizer { position: absolute; border: 2px solid #007bff; z-index: 9900; display: none; pointer-events: none; }
        .resizer-handle { position: absolute; width: 10px; height: 10px; background: #007bff; border: 1px solid white; pointer-events: auto; }
        .rh-se { bottom: -6px; right: -6px; cursor: nwse-resize; }

        #context-menu { position: fixed; background: white; border: 1px solid #ccc; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 6px; z-index: 9999; display: none; width: 230px; }
        .menu-item { padding: 8px 12px; cursor: pointer; font-size: 13px; display: flex; justify-content: space-between; align-items: center; color: #333; }
        .menu-item:hover { background: #e7f5ff; color: #007bff; }
        .menu-sep { height: 1px; background: #eee; margin: 4px 0; }
        .menu-title { font-size: 10px; color: #888; padding: 5px 10px; background: #f8f9fa; font-weight: bold; }
        .shortcut-badge { font-size: 10px; color: #999; background: #f1f3f5; padding: 1px 4px; border-radius: 3px; }

        .btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; background: white; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
        .btn:hover { background: #f8f9fa; }
        .btn-primary { background: #007bff; color: white; border: none; font-weight: bold; }
        .btn-warning { background: #ffc107; color: #212529; border: none; font-weight: bold; }
        .btn-success { background: #28a745; color: white; border: none; font-weight: bold; }
        .btn-danger { background: #dc3545; color: white; border: none; font-weight: bold; }
        .btn-purple { background: #6f42c1; color: white; border: none; font-weight: bold; }
        .btn-sm { padding: 4px 8px; width: auto; font-size: 12px; }

        .settings-panel { background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; padding:10px; margin-bottom:15px; }
        .settings-row { display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:5px; }
        .settings-row label { color:#333; font-weight:bold; }
        .settings-row input[type="number"], .settings-row input[type="text"] { width:60px; padding:2px; text-align:center; border:1px solid #ddd; border-radius:3px; }

        #folder-status { font-size: 11px; color: #28a745; font-weight: bold; display: none; margin-bottom: 5px; }
        #folder-status.active { display: block; }
        
        .shortcut-guide { margin-top: 15px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 0; font-size: 11px; color: #333; height: 220px; overflow-y: auto; }
        .shortcut-header { background: #f1f3f5; padding: 8px; font-weight: bold; font-size: 12px; border-bottom: 1px solid #ddd; position: sticky; top:0; }
        .shortcut-list { padding: 5px; }
        .shortcut-item { display: flex; justify-content: space-between; padding: 4px 8px; border-bottom: 1px dashed #eee; }
        .shortcut-item:last-child { border-bottom: none; }
        .shortcut-key { font-weight: bold; color: #007bff; background: #e7f5ff; padding: 1px 5px; border-radius: 3px; font-family: monospace; }
        
        @media print {
            @page { size: A4 portrait; margin: 0; }
            .sidebar, #floating-toolbar, #image-resizer, #context-menu, .block-handle, .block-actions, #loading-indicator, #drop-overlay, .modal-overlay { display: none !important; }
            body, .workspace { background: white; overflow: visible; display: block; margin: 0; padding: 0; }
            .page { 
                display: flex !important; flex-direction: column !important; margin: 0; 
                box-shadow: none; border: none; page-break-after: always; 
                transform: none !important; width: 210mm; height: 297mm !important; 
                overflow: hidden !important; /* [Fix] ì¸ì‡„ ì‹œì—ëŠ” ë„˜ì¹œ ê²ƒ ìë¦„ */
            }
            .page.page-first { height: 297mm !important; }
            .body-container { flex-grow: 1 !important; margin-bottom: 0 !important; height: auto !important; }
            .page-footer { flex-shrink: 0; margin-top: auto !important; width: 100%; z-index: 10; background: white; text-align: center; font-size: 10pt; }
            .image-placeholder, .break-line { display: none; }
            .bg-gray-block { background-color: #f1f3f5 !important; -webkit-print-color-adjust: exact; }
            .spacer-block { border: none !important; background: none !important; }
            /* [Fix] ì¸ì‡„ ì‹œ ë¸”ë¡ íŒ¨ë”© ì—†ìŒ (ê¸°ë³¸) */
            .block-wrapper { padding-right: 0 !important; }
            #paper-container { transform: none !important; }
            mjx-container { color: #222 !important; }
            .blank-box { border-color: #000 !important; color: #000 !important; }
        }
    </style>
</head>
<body>

<div id="loading-indicator">ğŸ”„ ì²˜ë¦¬ ì¤‘...</div>
<div id="drop-overlay">ğŸ“‚ íŒŒì¼ ë†“ê¸° (Import)</div>
<input type="file" id="imgUpload" accept="image/*" style="display:none;">

<div id="import-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; display:flex; justify-content:space-between;">
            <span>ğŸ“¥ AI ë°ì´í„° ì…ë ¥ (í˜¸í™˜ ëª¨ë“œ)</span>
            <span style="cursor:pointer;" onclick="closeModal('import-modal')">Ã—</span>
        </div>
        <textarea id="import-textarea" class="modal-textarea" placeholder="ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn btn-warning" onclick="confirmImport(true)" style="width:auto;">ë®ì–´ì“°ê¸°</button>
            <button class="btn btn-primary" onclick="confirmImport(false)" style="width:auto;">ì´ì–´ì“°ê¸°</button>
            <button class="btn" onclick="closeModal('import-modal')" style="width:auto;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div id="find-replace-modal" class="modal-overlay">
    <div class="modal-content">
        <div style="font-weight:bold; font-size:16px;">ğŸ” ì¼ê´„ ë°”ê¾¸ê¸°</div>
        <div class="fr-row">
            <span class="fr-label">ì°¾ì„ ë‚´ìš©</span>
            <input type="text" id="fr-find-input" class="fr-input" placeholder="ì°¾ì„ í…ìŠ¤íŠ¸">
        </div>
        <div class="fr-row">
            <span class="fr-label">ë°”ê¿€ ë‚´ìš©</span>
            <input type="text" id="fr-replace-input" class="fr-input" placeholder="ë°”ê¿€ í…ìŠ¤íŠ¸">
        </div>
        <div class="fr-actions">
            <button class="btn btn-primary btn-sm" onclick="executeFindReplace()">ëª¨ë‘ ë°”ê¾¸ê¸°</button>
            <button class="btn btn-sm" onclick="closeModal('find-replace-modal')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="floating-toolbar">
    <button class="ft-btn" onmousedown="execStyle('bold')" title="êµµê²Œ">B</button>
    <button class="ft-btn" onmousedown="execStyle('italic')" title="ê¸°ìš¸ì„">I</button>
    <button class="ft-btn" onmousedown="execStyle('underline')" title="ë°‘ì¤„">U</button>
    <div class="ft-sep"></div>
    <button class="ft-btn" onmousedown="execStyle('justifyLeft')" title="ì™¼ìª½">â‡¤</button>
    <button class="ft-btn" onmousedown="execStyle('justifyCenter')" title="ê°€ìš´ë°">â†”</button>
    <button class="ft-btn" onmousedown="execStyle('justifyRight')" title="ì˜¤ë¥¸ìª½">â‡¥</button>
    <div class="ft-sep"></div>
    <button class="ft-btn" onmousedown="execStyle('foreColor', '#dc3545')" style="color:#dc3545">â—</button>
    <button class="ft-btn" onmousedown="execStyle('foreColor', '#007bff')" style="color:#007bff">â—</button>
    <button class="ft-btn" onmousedown="execStyle('foreColor', '#000000')">â—</button>
</div>

<div id="image-resizer">
    <div class="resizer-handle rh-se"></div>
</div>

<div id="context-menu">
    <div class="menu-title">ë¸”ë¡ í¸ì§‘</div>
    <div class="menu-item" onclick="toggleGrayBg()"><span>ğŸ¨ íšŒìƒ‰ ë°°ê²½</span><span class="shortcut-badge">Ctrl+Alt+G</span></div>
    <div class="menu-item" onclick="toggleBorder()"><span>ğŸ”² í…Œë‘ë¦¬ ë°•ìŠ¤</span><span class="shortcut-badge">Ctrl+Alt+B</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="applyAlign('left')"><span>â‡¤ ì™¼ìª½ ì •ë ¬</span><span class="shortcut-badge">Ctrl+Sh+L</span></div>
    <div class="menu-item" onclick="applyAlign('center')"><span>â†” ê°€ìš´ë° ì •ë ¬</span><span class="shortcut-badge">Ctrl+Sh+M</span></div>
    <div class="menu-item" onclick="applyAlign('right')"><span>â‡¥ ì˜¤ë¥¸ìª½ ì •ë ¬</span><span class="shortcut-badge">Ctrl+Sh+R</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="duplicateTargetBlock()"><span>ğŸ“‹ ë³µì œí•˜ê¸°</span><span class="shortcut-badge">Ctrl+D</span></div>
    <div class="menu-item" onclick="addBlockAbove('example')"><span>â• ìœ„ì— ì¶”ê°€</span><span class="shortcut-badge">Alt+Enter</span></div>
    <div class="menu-item" onclick="addBlockBelow('example')"><span>â• ì•„ë˜ì— ì¶”ê°€</span><span class="shortcut-badge">Enter</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="insertImageBoxSafe()"><span>ğŸ–¼ï¸ ì´ë¯¸ì§€ ë°•ìŠ¤ ì¶”ê°€</span><span class="shortcut-badge">Ctrl+Alt+I</span></div>
    <div class="menu-item" onclick="addBlockBelow('spacer')"><span>â†• ì—¬ë°± ë¸”ë¡ ì¶”ê°€</span><span class="shortcut-badge">Ctrl+Sh+Click</span></div>
    <div class="menu-item" onclick="addBlockBelow('break')"><span>âš¡ ë‹¨ ë‚˜ëˆ„ê¸° ì¶”ê°€</span><span class="shortcut-badge">Ctrl+Alt+Click</span></div>
    <div class="menu-sep"></div>
    <div class="menu-item" onclick="deleteTargetBlock()" style="color:#dc3545;"><span>ğŸ—‘ï¸ ì‚­ì œí•˜ê¸°</span><span class="shortcut-badge">Delete</span></div>
</div>

<nav class="sidebar">
    <div style="font-weight:bold; font-size:16px; margin-bottom:15px; border-bottom:2px solid #333; padding-bottom:5px;">
        ğŸ“ ìˆ˜í•™ ì—ë””í„° v3.9
        <div style="font-size:10px; color:#666; font-weight:normal;">Final Optimized (Drag & Space)</div>
    </div>
    
    <div class="settings-panel" style="background:#e8f5e9; border:1px solid #c8e6c9;">
        <div style="font-size:11px; font-weight:bold; margin-bottom:5px;">ğŸ“‚ ë¡œì»¬ ì‘ì—… í´ë” (ì„ íƒ)</div>
        <div id="folder-status">âœ… í´ë” ì—°ê²°ë¨</div>
        <div class="settings-row">
            <label>ì´ë¯¸ì§€ í´ë”ëª…</label>
            <input type="text" id="setting-img-folder" value="images" style="width:80px;">
        </div>
        <button class="btn btn-success" onclick="FileSystem.openProjectFolder()">ğŸ“‚ ì‘ì—… í´ë” ì—´ê¸°</button>
        <div style="font-size:10px; color:#666; margin-top:5px;">* ë¡œì»¬ ì €ì¥ ì‹œ ì´ë¯¸ì§€ ìë™ ê´€ë¦¬</div>
    </div>

    <button class="btn btn-purple" onclick="ManualRenderer.renderAll()" style="margin-bottom:15px; padding: 12px;">
        âš¡ ìˆ˜ì‹ ë³€í™˜ (Render)<br>
        <span style="font-size:10px; opacity:0.8;">Click: $..$ â†’ SVG / DblClick: Edit</span>
    </button>

    <div style="margin-bottom:10px;">
        <span style="font-size:12px;">í™•ëŒ€/ì¶•ì†Œ</span>
        <input type="range" id="zoomRange" min="0.5" max="1.5" step="0.1" value="1.0" style="width: 100%;">
    </div>
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <button class="btn" style="width:48%" onclick="performUndo()" title="ì‹¤í–‰ ì·¨ì†Œ">â†¶ Undo<br><span style="font-size:9px;">(Ctrl+Z)</span></button>
        <button class="btn" style="width:48%" onclick="performRedo()" title="ë‹¤ì‹œ ì‹¤í–‰">â†· Redo<br><span style="font-size:9px;">(Ctrl+Shift+Z)</span></button>
    </div>

    <button class="btn btn-success" onclick="insertImageBoxSafe()" style="margin-bottom:15px;">
        ğŸ–¼ï¸ ì´ë¯¸ì§€ ë°•ìŠ¤ ë„£ê¸° (Ctrl+Alt+I)
    </button>

    <div class="settings-panel">
        <div style="font-size:11px; font-weight:bold; margin-bottom:5px; border-bottom:1px solid #ddd; padding-bottom:3px;">âš™ï¸ AI ì…ë ¥ ì„¤ì •</div>
        <div class="settings-row">
            <label>ë‹¨ë³„ ë¬¸ì œ ìˆ˜</label>
            <input type="number" id="setting-limit" value="0" title="0ì´ë©´ ì œí•œ ì—†ìŒ">
        </div>
        <div class="settings-row">
            <label>ìë™ ì—¬ë°±</label>
            <input type="checkbox" id="setting-spacer" checked>
        </div>
    </div>

    <div style="border-top:1px solid #eee; padding-top:10px;">
        <button class="btn" onclick="openModal('import-modal')" style="border-left: 3px solid #6f42c1; color: #6f42c1; font-weight:bold;">ğŸ“¥ AI ë°ì´í„° ì…ë ¥ (Alt+I)</button>
        <button class="btn btn-warning" onclick="resetProject()">ğŸ—‘ï¸ ì´ˆê¸°í™” (Alt+N)</button>
        <button class="btn btn-primary" onclick="saveProjectJSON()">ğŸ’¾ ì €ì¥ (Ctrl+S)</button>
        <button class="btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ ì—´ê¸° (Ctrl+O)</button>
        <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadProjectJSONFromInput(this)">
    </div>

    <div class="shortcut-guide">
        <div class="shortcut-header">âŒ¨ï¸ ë‹¨ì¶•í‚¤ ê°€ì´ë“œ</div>
        <div class="shortcut-list">
            <div class="shortcut-item"><span>ì•„ë˜ì— ì¶”ê°€</span><span class="shortcut-key">Enter</span></div>
            <div class="shortcut-item"><span>ìœ„ì— ì¶”ê°€</span><span class="shortcut-key">Alt+Enter</span></div>
            <div class="shortcut-item"><span>ê³µë°±(10ì¹¸)</span><span class="shortcut-key">Sh+Tab</span></div>
            <div class="shortcut-item"><span>ë‹¨ ë‚˜ëˆ„ê¸°</span><span class="shortcut-key">Ctrl+Alt+Click</span></div>
            <div class="shortcut-item"><span>ì—¬ë°± ì¶”ê°€</span><span class="shortcut-key">Ctrl+Sh+Click</span></div>
            <div class="shortcut-item"><span>ë¸”ë¡ ë³µì œ</span><span class="shortcut-key">Ctrl+D</span></div>
            <div class="shortcut-item"><span>ì¤„ë°”ê¿ˆ(ìˆ˜ì‹ì•)</span><span class="shortcut-key">Sh+Enter</span></div>
            <div class="shortcut-item"><span>ì´ë¯¸ì§€ ë°•ìŠ¤</span><span class="shortcut-key">Ctrl+Alt+I</span></div>
            <div class="shortcut-item"><span>íšŒìƒ‰ ë°°ê²½</span><span class="shortcut-key">Ctrl+Alt+G</span></div>
            <div class="shortcut-item"><span>í…Œë‘ë¦¬ ë°•ìŠ¤</span><span class="shortcut-key">Ctrl+Alt+B</span></div>
            <div class="shortcut-item"><span>ì‹¤í–‰ ì·¨ì†Œ</span><span class="shortcut-key">Ctrl+Z</span></div>
            <div class="shortcut-item"><span>ì €ì¥í•˜ê¸°</span><span class="shortcut-key">Ctrl+S</span></div>
        </div>
    </div>

    <div style="margin-top:auto;">
        <button class="btn btn-danger" onclick="printWithMath()">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>
    </div>
</nav>

<main class="workspace" id="workspace">
    <div id="paper-container"></div>
</main>

<script>
    // [ì „ì—­ ìƒíƒœ]
    let docData = {
        meta: { title: "ì‹œí—˜ì§€ ì œëª©", subtitle: "ë‹¨ì›ëª…", footerText: "í•™ì›ëª…", zoom: 1.0 },
        blocks: [ { id: 'b0', type: 'concept', content: '<span class="q-label">ì•ˆë‚´</span> ë‚´ìš© ì…ë ¥...' } ]
    };
    let historyStack = []; let historyIndex = -1; 
    let selectedPlaceholder = null; let selectedImage = null; 
    let contextTargetId = null; let dragSrcId = null;
    let renderTimer = null; let keysPressed = {}; 
    let lastFocusId = null;
    window.isMathJaxReady = false;

    // [ìœ í‹¸ë¦¬í‹°] ë””ë°”ìš´ìŠ¤ í•¨ìˆ˜
    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(context, args), wait);
        };
    }

    // [Helper] ì•„í†° ê²½ê³„ ê°ì§€
    function getAtomBeforeCaret(container) { 
        const sel = window.getSelection(); if (!sel.rangeCount || !sel.isCollapsed) return null; 
        const range = sel.getRangeAt(0); let node = range.startContainer; let offset = range.startOffset; 
        if (!container.contains(node)) return null; 
        if (node.nodeType === Node.TEXT_NODE) { 
            if (offset === 0) { 
                let prev = node.previousSibling; 
                while (prev && prev.nodeType === Node.TEXT_NODE && prev.nodeValue === '') prev = prev.previousSibling; 
                if (prev && (prev.tagName === 'MJX-CONTAINER' || prev.classList?.contains('blank-box'))) return prev; 
            } return null; 
        } 
        if (node.nodeType === Node.ELEMENT_NODE) { 
            const idx = offset - 1; if (idx >= 0) { const prev = node.childNodes[idx]; if (prev && (prev.tagName === 'MJX-CONTAINER' || prev.classList?.contains('blank-box'))) return prev; } 
        } return null; 
    }
    function getAtomAfterCaret(container) { 
        const sel = window.getSelection(); if (!sel.rangeCount || !sel.isCollapsed) return null; 
        const range = sel.getRangeAt(0); let node = range.startContainer; let offset = range.startOffset; 
        if (!container.contains(node)) return null; 
        if (node.nodeType === Node.TEXT_NODE) { 
            if (offset === node.nodeValue.length) { 
                let next = node.nextSibling; 
                while (next && next.nodeType === Node.TEXT_NODE && next.nodeValue === '') next = next.nextSibling; 
                if (next && (next.tagName === 'MJX-CONTAINER' || next.classList?.contains('blank-box'))) return next; 
            } return null; 
        } 
        if (node.nodeType === Node.ELEMENT_NODE) { const next = node.childNodes[offset]; if (next && (next.tagName === 'MJX-CONTAINER' || next.classList?.contains('blank-box'))) return next; } 
        return null; 
    }

    // [Fix] Rich Content(HTML) -> Clean Tex ë³€í™˜
    function cleanRichContentToTex(htmlContent) {
        const div = document.createElement('div');
        div.innerHTML = htmlContent;
        div.querySelectorAll('mjx-container').forEach(mjx => {
            const tex = mjx.getAttribute('data-tex');
            const isDisplay = mjx.getAttribute('display') === 'true'; 
            if (tex) mjx.replaceWith(document.createTextNode(isDisplay ? `$$${tex}$$` : `$${tex}$`));
        });
        div.querySelectorAll('.blank-box').forEach(blank => {
            blank.replaceWith(document.createTextNode(`[ë¹ˆì¹¸:${blank.innerText}]`));
        });
        return div.innerHTML;
    }

    const ImportParser = {
        parse(text) {
            const blocks = []; const rawItems = text.split('[[').filter(s => s.trim().length > 0);
            rawItems.forEach(chunk => {
                const closeIdx = chunk.indexOf(']]'); if (closeIdx === -1) return;
                const meta = chunk.substring(0, closeIdx); let content = chunk.substring(closeIdx + 2).trim();
                if (content.startsWith(':')) content = content.substring(1).trim();
                content = content.replace(/\[ì´ë¯¸ì§€:(.*?)\]/g, '<span class="image-placeholder">[ì´ë¯¸ì§€: $1]</span>');
                content = content.replace(/\[ë¹ˆì¹¸:(.*?)\]/g, '<span class="blank-box" contenteditable="false">$1</span>');
                content = content.replace(/\n/g, '<br>');
                const [stylePart, labelPart] = meta.includes('_') ? meta.split('_') : ['ê¸°ë³¸', meta];
                const styles = stylePart.split(',');
                let type = 'example'; let bordered = styles.includes('ë°•ìŠ¤'); let bgGray = styles.includes('ìŒì˜');
                let label = labelPart ? `<span class="q-label">${labelPart}</span>` : '';
                if (styles.includes('ê°œë…')) type = 'concept';
                blocks.push({ id: 'imp_' + Date.now() + Math.random(), type: type, content: label + ' ' + content, bordered: bordered, bgGray: bgGray });
            });
            return blocks;
        }
    };

    // [í•µì‹¬ ì—”ì§„] ManualRenderer
    const ManualRenderer = {
        mathCache: new Map(),

        async renderAll() {
            if (!window.isMathJaxReady) { console.log("MathJax Waiting..."); return; }
            if (this.isRendering) return; 
            this.isRendering = true;

            try {
                showLoading("âš¡ ìˆ˜ì‹ ë³€í™˜ ì¤‘...");
                const boxes = document.querySelectorAll('.editable-box');
                for (let box of boxes) await this.typesetElement(box);
                rebalanceLayout(); 
            } catch(e) {
                console.error("Render Error:", e);
            } finally {
                this.isRendering = false;
                hideLoading();
            }
        },

        async typesetElement(element) {
            if (element.querySelector('mjx-container') || element.querySelector('.blank-box')) {
                element.innerHTML = cleanRichContentToTex(element.innerHTML);
            }
            element.innerHTML = element.innerHTML.replace(/\[ë¹ˆì¹¸:(.*?)\]/g, '<span class="blank-box" contenteditable="false">$1</span>');

            const regex = /(\$\$[\s\S]+?\$\$|\$[\s\S]+?\$)/g;
            const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT, null, false);
            const textNodes = [];
            while(walker.nextNode()) textNodes.push(walker.currentNode);

            for (let node of textNodes) {
                const text = node.nodeValue;
                if (!text.match(regex)) continue;
                const fragment = document.createDocumentFragment();
                let lastIndex = 0; regex.lastIndex = 0; let match;
                while ((match = regex.exec(text)) !== null) {
                    if (match.index > lastIndex) fragment.appendChild(document.createTextNode(text.substring(lastIndex, match.index)));
                    
                    const fullTex = match[0]; 
                    const isDisplay = fullTex.startsWith('$$'); 
                    const cleanTex = isDisplay ? fullTex.slice(2, -2) : fullTex.slice(1, -1);
                    
                    const cacheKey = cleanTex + (isDisplay ? '_D' : '_I');
                    let mjxNode = null;

                    if (this.mathCache.has(cacheKey)) {
                        mjxNode = this.mathCache.get(cacheKey).cloneNode(true);
                    } else {
                        try {
                            mjxNode = await MathJax.tex2svgPromise(cleanTex, { display: isDisplay });
                            if (mjxNode) {
                                mjxNode.setAttribute('data-tex', cleanTex); 
                                mjxNode.setAttribute('display', isDisplay);
                                mjxNode.setAttribute('contenteditable', 'false');
                                mjxNode.classList.add('math-atom');
                                this.mathCache.set(cacheKey, mjxNode.cloneNode(true));
                            }
                        } catch(e) { console.error(e); }
                    }

                    if (mjxNode) fragment.appendChild(mjxNode);
                    else fragment.appendChild(document.createTextNode(fullTex));

                    lastIndex = regex.lastIndex;
                }
                if (lastIndex < text.length) fragment.appendChild(document.createTextNode(text.substring(lastIndex)));
                node.parentNode.replaceChild(fragment, node);
            }
        },

        revertToSource(mjxContainer) {
            const tex = mjxContainer.getAttribute('data-tex');
            const isDisplay = mjxContainer.getAttribute('display') === 'true';
            if (tex) mjxContainer.replaceWith(document.createTextNode(isDisplay ? `$$${tex}$$` : `$${tex}$`));
        },

        syncBlock(id) {
            const wrap = document.querySelector(`.block-wrapper[data-id="${id}"]`); if (!wrap) return;
            const box = wrap.querySelector('.editable-box');
            if (box) updateBlockContent(id, cleanRichContentToTex(box.innerHTML), false);
        },
        
        syncAllBlocks() { 
            const newBlocks = [];
            document.querySelectorAll('.block-wrapper').forEach(wrap => {
                const id = wrap.dataset.id;
                const block = docData.blocks.find(b => b.id === id);
                if(block) {
                    const box = wrap.querySelector('.editable-box');
                    if(box) block.content = cleanRichContentToTex(box.innerHTML);
                    newBlocks.push(block);
                }
            });
            docData.blocks = newBlocks;
            saveHistoryDebounced(); 
        }
    };

    const FileSystem = {
        dirHandle: null,
        async openProjectFolder() {
            if (!window.showDirectoryPicker) { alert("ë¸Œë¼ìš°ì € ë¯¸ì§€ì›"); return; }
            try { this.dirHandle = await window.showDirectoryPicker(); document.getElementById('folder-status').classList.add('active'); alert("âœ… í´ë” ì—°ê²°ë¨"); this.loadImagesForDisplay(docData.blocks); } catch (e) { }
        },
        async saveImage(file) {
            if (!this.dirHandle) { alert("âš ï¸ í´ë” ë¯¸ì—°ê²°"); return null; }
            try {
                const folderName = document.getElementById('setting-img-folder').value || 'images';
                const imgDir = await this.dirHandle.getDirectoryHandle(folderName, { create: true });
                const filename = `img_${new Date().toISOString().replace(/[-:T.]/g,'').slice(2,14)}.${file.name.split('.').pop()||'png'}`;
                const fileHandle = await imgDir.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable(); await writable.write(file); await writable.close();
                const savedFile = await fileHandle.getFile();
                return { filename, url: URL.createObjectURL(savedFile), path: `./${folderName}/${filename}` };
            } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); return null; }
        },
        async loadImagesForDisplay(blocks) {
            if (!this.dirHandle) return;
            const folderName = document.getElementById('setting-img-folder').value || 'images';
            try {
                const imgDir = await this.dirHandle.getDirectoryHandle(folderName);
                for (let block of blocks) {
                    if (block.content.includes('<img')) {
                        const div = document.createElement('div'); div.innerHTML = block.content;
                        let modified = false;
                        const imgs = div.querySelectorAll('img');
                        for (let img of imgs) {
                            const src = img.getAttribute('src');
                            if (src && src.startsWith(`./${folderName}/`)) {
                                try { const fh = await imgDir.getFileHandle(src.split('/').pop()); const f = await fh.getFile(); img.src = URL.createObjectURL(f); modified = true; } catch (e) { }
                            }
                        }
                        if (modified) block.content = div.innerHTML;
                    }
                }
            } catch (e) { }
        }
    };

    async function saveProjectJSON() {
        ManualRenderer.syncAllBlocks();
        if (!FileSystem.dirHandle) { if(!confirm("ë¡œì»¬ í´ë” ë¯¸ì—°ê²°. ë‹¤ìš´ë¡œë“œ?")) return; }
        showLoading("ğŸ’¾ ì €ì¥ ì¤‘...");
        
        const rawData = JSON.parse(JSON.stringify(docData)); 
        rawData.blocks.forEach(block => {
            block.content = cleanRichContentToTex(block.content);
            if (block.content.includes('<img')) {
                const div = document.createElement('div'); div.innerHTML = block.content;
                div.querySelectorAll('img').forEach(img => { if (img.dataset.path) img.src = img.dataset.path; });
                block.content = div.innerHTML;
            }
        });

        if (FileSystem.dirHandle) {
            try {
                const fileHandle = await FileSystem.dirHandle.getFileHandle('data.json', { create: true });
                const writable = await fileHandle.createWritable(); await writable.write(JSON.stringify(rawData, null, 2)); await writable.close();
                hideLoading(); alert("âœ… ì €ì¥ ì™„ë£Œ!");
            } catch(e) { alert("ì˜¤ë¥˜: " + e.message); hideLoading(); }
        } else {
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(rawData, null, 2)], {type:'application/json'})); a.download = 'exam_v3.8.json'; a.click(); hideLoading();
        }
    }

    function createPage(num) {
        const div=document.createElement('div'); div.className='page'; if(num===1) div.classList.add('page-first');
        const headerHTML = num === 1 ? 
            `<table class="header-table"><colgroup><col class="col-title"><col class="col-label"><col class="col-input-wide"><col class="col-label"><col class="col-input-narrow"></colgroup><tr><td rowspan="2" class="col-title">TEST</td><td class="col-label">ê³¼ì •</td><td><input class="header-input" value="${docData.meta.title}" oninput="docData.meta.title=this.value;saveHistoryDebounced()"></td><td class="col-label">ì„±ëª…</td><td><input class="header-input"></td></tr><tr><td class="col-label">ë‹¨ì›</td><td><input class="header-input" value="${docData.meta.subtitle}" oninput="docData.meta.subtitle=this.value;saveHistoryDebounced()"></td><td class="col-label">ì ìˆ˜</td><td></td></tr></table>` : `<div class="header-line"></div>`;
        const footerHTML = num === 1 ? `<div class="footer-content-first">- ${num} -</div>` : `<div class="footer-line"></div><div>- ${num} -</div>`;
        div.innerHTML=`<div class="header-area">${headerHTML}</div><div class="body-container"><div class="column left"></div><div class="column right"></div></div><div class="page-footer">${footerHTML}</div>`;
        return div;
    }

    // [Fix: Option C] ì•ˆì „í•œ ë ˆì´ì•„ì›ƒ ë°¸ëŸ°ì‹±
    function rebalanceLayout() {
        const container = document.getElementById('paper-container');
        let pages = Array.from(container.querySelectorAll('.page'));
        let columns = [];
        pages.forEach(p => {
            columns.push(p.querySelector('.column.left'));
            columns.push(p.querySelector('.column.right'));
        });

        const MAX_LOOPS = 50; 
        let loopCount = 0;

        for (let i = 0; i < columns.length; i++) {
            let col = columns[i];
            if (loopCount++ > MAX_LOOPS) { console.warn("Layout rebalance limit reached."); break; }
            
            while (col.scrollHeight > col.clientHeight + 2) {
                if (col.children.length <= 1) break; 
                
                const lastBlock = col.lastElementChild;
                let nextCol = columns[i + 1];
                if (!nextCol) {
                    const newPageNum = pages.length + 1;
                    const newPage = createPage(newPageNum);
                    container.appendChild(newPage);
                    pages.push(newPage);
                    const nl = newPage.querySelector('.column.left');
                    const nr = newPage.querySelector('.column.right');
                    columns.push(nl);
                    columns.push(nr);
                    nextCol = nl;
                }
                
                if (nextCol.firstChild) nextCol.insertBefore(lastBlock, nextCol.firstChild);
                else nextCol.appendChild(lastBlock);
            }
        }
    }

    const debouncedRebalance = debounce(() => { rebalanceLayout(); }, 300);

    function renderPages() { 
        const container = document.getElementById('paper-container'); 
        container.innerHTML = ''; 
        if(docData.meta.zoom) { container.style.transform = `scale(${docData.meta.zoom})`; container.style.transformOrigin = 'top center'; document.getElementById('zoomRange').value = docData.meta.zoom; }

        let pageNum = 1; let currentPage = createPage(pageNum); container.appendChild(currentPage);
        let colL = currentPage.querySelector('.left'); let colR = currentPage.querySelector('.right'); let curCol = colL; 

        function moveToNextColumn() {
            if (curCol === colL) { curCol = colR; } 
            else {
                pageNum++; currentPage = createPage(pageNum); container.appendChild(currentPage);
                colL = currentPage.querySelector('.left'); colR = currentPage.querySelector('.right'); curCol = colL;
            }
        }

        docData.blocks.forEach((block) => { 
            if (block.type === 'break') { curCol.appendChild(createBlock(block)); moveToNextColumn(); return; } 
            const el = createBlock(block); curCol.appendChild(el); 
            if (curCol.scrollHeight > curCol.clientHeight + 5) { 
                if (curCol.children.length === 1) { moveToNextColumn(); } 
                else { curCol.removeChild(el); moveToNextColumn(); curCol.appendChild(el); } 
            } 
        });
        
        if(lastFocusId) { setTimeout(() => { const el = document.querySelector(`.block-wrapper[data-id="${lastFocusId}"] .editable-box`); if(el) { el.focus(); const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r); lastFocusId=null; } }, 0); }
    }

    function createBlock(block) {
        const wrap=document.createElement('div'); wrap.className='block-wrapper'; wrap.dataset.id=block.id;
        if(block.style && block.style.textAlign) wrap.style.textAlign = block.style.textAlign;
        if(block.bgGray) wrap.classList.add('bg-gray-block'); 

        const actions = document.createElement('div'); actions.className = 'block-actions';
        const btnBr = document.createElement('button'); btnBr.className = 'block-action-btn'; btnBr.innerText = 'â¤µ'; btnBr.title='ë‹¨ ë‚˜ëˆ„ê¸°'; btnBr.onclick=(e)=>{ e.stopPropagation(); contextTargetId=block.id; addBlockBelow('break'); };
        const btnSp = document.createElement('button'); btnSp.className = 'block-action-btn'; btnSp.innerText = 'â–±'; btnSp.title='ì—¬ë°±'; btnSp.onclick=(e)=>{ e.stopPropagation(); contextTargetId=block.id; addBlockBelow('spacer'); };
        actions.appendChild(btnBr); actions.appendChild(btnSp); wrap.appendChild(actions);

        wrap.addEventListener('click', (e) => {
             if (!(e.ctrlKey || e.metaKey)) return;
             if (e.altKey) { e.preventDefault(); e.stopPropagation(); contextTargetId = block.id; addBlockBelow('break'); return; }
             if (e.shiftKey) { e.preventDefault(); e.stopPropagation(); contextTargetId = block.id; addBlockBelow('spacer'); return; }
        });

        wrap.draggable = false; 
        const handle = document.createElement('div'); handle.className = 'block-handle'; handle.draggable = true; 
        handle.addEventListener('dragstart', (e) => {
            e.stopPropagation(); dragSrcId = block.id;
            const wrapper = e.target.closest('.block-wrapper'); wrapper.classList.add('dragging');
            if (e.dataTransfer) { e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', block.id); try { e.dataTransfer.setDragImage(wrapper, 0, 0); } catch(err) {} }
        });
        handle.addEventListener('dragend', (e) => {
             e.stopPropagation(); dragSrcId = null;
             document.querySelectorAll('.block-wrapper').forEach(w => w.classList.remove('dragging', 'drop-target-top', 'drop-target-bottom'));
             ManualRenderer.syncAllBlocks();
        });
        
        // [Fix: UX Improvement] í† ê¸€ ê¸°ëŠ¥ ì¶”ê°€
        handle.onclick = (e) => {
            e.stopPropagation();
            const m = document.getElementById('context-menu');
            if (m.style.display === 'block' && contextTargetId === block.id) {
                m.style.display = 'none';
                return;
            }
            contextTargetId = block.id;
            m.style.display = 'block';
            m.style.left = e.clientX + 'px';
            m.style.top = e.clientY + 'px';
        };
        wrap.appendChild(handle);

        wrap.ondragover=(e)=>{ e.preventDefault(); const r=wrap.getBoundingClientRect(); wrap.classList.remove('drop-target-top','drop-target-bottom'); if((e.clientY-r.top)<(r.height/2)) wrap.classList.add('drop-target-top'); else wrap.classList.add('drop-target-bottom'); };
        
        // [Fix] ë“œë¡­ ì¶©ëŒ ì™„ì „ í•´ê²° (íƒ€ì… ê¸°ë°˜ ì²´í¬)
        wrap.ondrop=(e)=>{ 
            // 1. ë§Œì•½ ë“œë¡­ëœ ë°ì´í„°ê°€ 'íŒŒì¼'ì´ë©´ -> ë¸”ë¡ ì´ë™ì´ ì•„ë‹˜ -> Bodyë¡œ í˜ë ¤ë³´ëƒ„
            const types = e.dataTransfer.types;
            if (types && (Array.from(types).includes('Files'))) {
                return; // stopPropagation í•˜ì§€ ì•ŠìŒ -> Bodyê°€ ì²˜ë¦¬
            }

            // 2. íŒŒì¼ì´ ì•„ë‹ˆë©´ (ë‚´ë¶€ ë¸”ë¡ ì´ë™) -> ì—¬ê¸°ì„œ ì²˜ë¦¬í•˜ê³  ëëƒ„
            e.preventDefault(); 
            e.stopPropagation(); // Bodyë¡œ ê°€ëŠ” ê²ƒ ë§‰ìŒ

            if(dragSrcId && dragSrcId !== block.id){ 
                const srcIdx=docData.blocks.findIndex(b=>b.id===dragSrcId); const tgtIdx=docData.blocks.findIndex(b=>b.id===block.id); 
                const [moved]=docData.blocks.splice(srcIdx,1); 
                if(wrap.classList.contains('drop-target-bottom')) docData.blocks.splice(tgtIdx+1,0,moved); else docData.blocks.splice(tgtIdx,0,moved); 
                (async () => {
                    renderPages(); 
                    await ManualRenderer.renderAll(); 
                    saveHistory();
                })();
            } 
            document.querySelectorAll('.block-wrapper').forEach(w=>w.classList.remove('dragging','drop-target-top','drop-target-bottom')); 
        };

        if(block.type==='break'){
            const br=document.createElement('div'); br.className='break-line'; 
            br.onclick=async ()=>{ if(confirm("ë‹¨ ë‚˜ëˆ„ê¸° ì‚­ì œ?")) await deleteBlockById(block.id); }; 
            wrap.appendChild(br);
        } else if(block.type==='spacer'){
            const sp=document.createElement('div'); sp.className='spacer-block'; sp.style.height=(block.height||50)+'px';
            sp.onmousedown=(e)=>{ const sY=e.clientY, sH=parseInt(sp.style.height); const mv=(ev)=>{ const nH=Math.max(10, sH+(ev.clientY-sY)); sp.style.height=nH+'px'; block.height=nH; }; window.addEventListener('mousemove',mv); window.addEventListener('mouseup',()=>{window.removeEventListener('mousemove',mv); saveHistory();},{once:true}); }; wrap.appendChild(sp);
        } else {
            const box=document.createElement('div'); box.className=`editable-box ${block.type}-box`;
            if(block.type==='concept') box.classList.add('concept-box');
            if(block.bordered) box.classList.add('bordered-box');
            box.innerHTML=block.content;
            box.contentEditable=true;
            box.addEventListener('blur', async () => {
                if(!window.isMathJaxReady) return;
                if(box.innerText.includes('[ë¹ˆì¹¸:') || box.innerText.includes('$')) {
                    if(box.innerText.includes('[ë¹ˆì¹¸:')) box.innerHTML = box.innerHTML.replace(/\[ë¹ˆì¹¸:(.*?)\]/g, '<span class="blank-box" contenteditable="false">$1</span>');
                    if(box.innerText.includes('$')) await ManualRenderer.typesetElement(box);
                }
                updateBlockContent(block.id, cleanRichContentToTex(box.innerHTML), true);
                debouncedRebalance(); 
            });
            box.oninput=()=>{ const cleanHTML = cleanRichContentToTex(box.innerHTML); updateBlockContent(block.id, cleanHTML, false); debouncedRebalance(); };
            box.addEventListener('mousedown', (e) => {
                if(e.target.tagName==='IMG') { showResizer(e.target); e.stopPropagation(); selectedImage=e.target; }
                if(e.target.classList.contains('image-placeholder')) { e.stopPropagation(); if(selectedPlaceholder) selectedPlaceholder.classList.remove('selected'); selectedPlaceholder = e.target; selectedPlaceholder.classList.add('selected'); selectedPlaceholder.setAttribute('contenteditable', 'false'); }
            });
            box.onkeydown = async (e) => {
                if (e.key === 'Backspace') {
                    const atomBefore = getAtomBeforeCaret(box); if (atomBefore) { e.preventDefault(); atomBefore.remove(); updateBlockContent(block.id, cleanRichContentToTex(box.innerHTML), true); return; }
                    if(box.innerText.trim() === '' && box.innerHTML.replace(/<br>/g,'').trim() === '') { 
                        const prevIdx = docData.blocks.findIndex(b=>b.id===block.id) - 1; 
                        if (prevIdx >= 0) { 
                            e.preventDefault(); 
                            const prevId = docData.blocks[prevIdx].id;
                            await deleteBlockById(block.id); 
                            lastFocusId = prevId;
                        } 
                    }
                }
                if (e.key === 'Enter' && e.shiftKey) { const atomAfter = getAtomAfterCaret(box); if (atomAfter) { e.preventDefault(); const br = document.createElement('br'); atomAfter.parentNode.insertBefore(br, atomAfter); const r = document.createRange(); const s = window.getSelection(); r.setStartAfter(br); r.collapse(true); s.removeAllRanges(); s.addRange(r); updateBlockContent(block.id, cleanRichContentToTex(box.innerHTML), true); return; } }
                if(e.key === 'Tab') { e.preventDefault(); if(e.shiftKey) document.execCommand('insertHTML', false, '&nbsp;'.repeat(10)); else if(e.ctrlKey) focusNextBlock(block.id, -1); else focusNextBlock(block.id, 1); return; }
                if(e.key === 'ArrowDown') { if (isCaretOnLastLine(box)) { e.preventDefault(); focusNextBlock(block.id, 1); } }
                if(e.key === 'ArrowUp') { if (isCaretOnFirstLine(box)) { e.preventDefault(); focusNextBlock(block.id, -1); } }
                if(e.key === 'Enter' && !e.shiftKey) {
                    if(e.ctrlKey) { e.preventDefault(); contextTargetId = block.id; addBlockBelow('break'); return; }
                    if(e.altKey) { e.preventDefault(); contextTargetId = block.id; addBlockAbove('example'); return; }
                    e.preventDefault(); contextTargetId = block.id; addBlockBelow('example'); 
                }
                if((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'b' || e.key === 'B')) { e.preventDefault(); contextTargetId=block.id; toggleBorder(); return; }
                if((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'g' || e.key === 'G')) { e.preventDefault(); contextTargetId=block.id; toggleGrayBg(); return; }
                if((e.ctrlKey || e.metaKey) && (e.key === 'd' || e.key === 'D')) { e.preventDefault(); contextTargetId=block.id; duplicateTargetBlock(); return; }
                if((e.ctrlKey || e.metaKey) && e.altKey && (e.key === 'i' || e.key === 'I')) { e.preventDefault(); insertImageBox(); return; }
                if((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'l' || e.key === 'L')) { e.preventDefault(); contextTargetId=block.id; applyAlign('left'); return; }
                if((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'r' || e.key === 'R')) { e.preventDefault(); contextTargetId=block.id; applyAlign('right'); return; }
                if((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'm' || e.key === 'M')) { e.preventDefault(); contextTargetId=block.id; applyAlign('center'); return; }
            };
            wrap.appendChild(box);
        }
        return wrap;
    }

    function handleGlobalDblClick(e) {
        const mjx = e.target.closest('mjx-container'); if (mjx) { e.preventDefault(); e.stopPropagation(); ManualRenderer.revertToSource(mjx); const wrap = e.target.closest('.block-wrapper'); if(wrap) ManualRenderer.syncBlock(wrap.dataset.id); return; }
        const blank = e.target.closest('.blank-box'); if (blank) { e.preventDefault(); e.stopPropagation(); const text = blank.innerText; blank.replaceWith(document.createTextNode(`[ë¹ˆì¹¸:${text}]`)); const wrap = e.target.closest('.block-wrapper'); if(wrap) ManualRenderer.syncBlock(wrap.dataset.id); return; }
        const placeholder = e.target.closest('.image-placeholder'); if (placeholder) { e.preventDefault(); e.stopPropagation(); if(selectedPlaceholder) selectedPlaceholder.classList.remove('selected'); selectedPlaceholder = placeholder; placeholder.classList.add('selected'); placeholder.setAttribute('contenteditable', 'false'); document.getElementById('imgUpload').click(); }
    }
    
    // [Fix] ë©”ë‰´ ë‹«ê¸° ê¸°ëŠ¥ ë³´ì™„
    function handleClickOutside(e) { 
        if (!e.target.closest('#floating-toolbar') && !e.target.closest('.ft-btn')) hideToolbar(); 
        if (!e.target.closest('img') && !e.target.closest('#image-resizer')) hideResizer(); 
        
        const menu = document.getElementById('context-menu');
        if (menu && menu.style.display === 'block') {
            const isMenuInside = e.target.closest('#context-menu');
            const isHandle = e.target.closest('.block-handle');
            if (!isMenuInside && !isHandle) { menu.style.display = 'none'; }
        }

        if (!e.target.classList.contains('image-placeholder') && !e.target.closest('#imgUpload')) { if(selectedPlaceholder) { selectedPlaceholder.classList.remove('selected'); selectedPlaceholder.setAttribute('contenteditable', 'false'); } selectedPlaceholder = null; } 
    }
    
    function handleGlobalMouseUp(e) { setTimeout(() => { const sel = window.getSelection(); if (sel.rangeCount && !sel.isCollapsed) { const range = sel.getRangeAt(0); const container = range.commonAncestorContainer.nodeType===1 ? range.commonAncestorContainer : range.commonAncestorContainer.parentNode; if (container.closest('.editable-box')) { const rect = range.getBoundingClientRect(); const tb = document.getElementById('floating-toolbar'); tb.style.display = 'flex'; tb.style.top = (rect.top + window.scrollY - 45) + 'px'; tb.style.left = (rect.left + window.scrollX + rect.width / 2) + 'px'; } } }, 10); }
    function getCurrentBlockId() { if (contextTargetId) return contextTargetId; if (document.activeElement && document.activeElement.closest('.block-wrapper')) return document.activeElement.closest('.block-wrapper').dataset.id; return lastFocusId; }
    
    // [Fix] êµ¬ë¬¸ ì˜¤ë¥˜ ìˆ˜ì • ë° ESC í‚¤ í•¸ë“¤ë§ ì¶”ê°€
    function handleGlobalKeydown(e) { 
        // [ì¶”ê°€] ESC í‚¤ë¡œ ë‹«ê¸°
        if (e.key === 'Escape') {
            document.getElementById('context-menu').style.display = 'none';
            document.getElementById('floating-toolbar').style.display = 'none';
            hideResizer();
            closeModal('import-modal');
            closeModal('find-replace-modal');
            return;
        }

        keysPressed[e.key.toLowerCase()] = true; 
        if ((e.ctrlKey || e.metaKey) && keysPressed['q'] && keysPressed['f']) { e.preventDefault(); openModal('find-replace-modal'); document.getElementById('fr-find-input').focus(); keysPressed['f'] = false; return; } 
        if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveProjectJSON(); return; } 
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'z' || e.key === 'Z')) { e.preventDefault(); performRedo(); return; } 
        else if ((e.ctrlKey || e.metaKey) && (e.key === 'z' || e.key === 'Z')) { e.preventDefault(); performUndo(); return; } 
        if (e.ctrlKey && e.altKey && (e.key === 'g' || e.key === 'G')) { e.preventDefault(); contextTargetId = getCurrentBlockId(); if(contextTargetId) toggleGrayBg(); return; } 
        if (e.ctrlKey && e.altKey && (e.key === 'b' || e.key === 'B')) { e.preventDefault(); contextTargetId = getCurrentBlockId(); if(contextTargetId) toggleBorder(); return; } 
        if (e.ctrlKey && e.key === 'd') { e.preventDefault(); contextTargetId = getCurrentBlockId(); if(contextTargetId) duplicateTargetBlock(); return; }
    } // [Fix] ì—¬ê¸°ì— ë‹«ëŠ” ê´„í˜¸ë¥¼ ì¶”ê°€í•˜ì—¬ ì—ëŸ¬ í•´ê²°

    async function handleGlobalPaste(e) { 
        let target = null; 
        if (selectedPlaceholder && selectedPlaceholder.getAttribute('contenteditable') === 'false') target = selectedPlaceholder; 
        else { const sel = window.getSelection(); if (sel.rangeCount) { const node = sel.anchorNode; const el = node.nodeType === 1 ? node : node.parentElement; if (el.closest('.editable-box')) target = 'cursor'; } } 
        const items = (e.clipboardData || e.originalEvent.clipboardData).items; 
        for (let item of items) { 
            if (item.kind === 'file' && item.type.includes('image/')) { 
                if(!target) return; e.preventDefault(); const file = item.getAsFile(); showLoading("ğŸ’¾ ì´ë¯¸ì§€ ì €ì¥ ì¤‘..."); 
                let saved = null; 
                if(FileSystem.dirHandle) saved = await FileSystem.saveImage(file); 
                else { const reader = new FileReader(); saved = await new Promise(r => { reader.onload=ev=>r({url:ev.target.result, path:null}); reader.readAsDataURL(file); }); } 
                if(!saved) { hideLoading(); return; } 
                hideLoading(); const newImg = document.createElement('img'); newImg.src = saved.url; 
                if(saved.path) newImg.dataset.path = saved.path; newImg.style.maxWidth = '100%'; 
                if (target === selectedPlaceholder) { target.replaceWith(newImg); updateBlockContent(newImg.closest('.block-wrapper').dataset.id, newImg.closest('.editable-box').innerHTML); selectedPlaceholder = null; } 
                else if (target === 'cursor') { document.execCommand('insertHTML', false, newImg.outerHTML); } 
                saveHistoryDebounced(); return; 
            } 
        } 
    }

    function loadProjectFromFile(file) { if(!file) return; const r = new FileReader(); r.onload = async (e) => { try { docData = JSON.parse(e.target.result); if (FileSystem.dirHandle) await FileSystem.loadImagesForDisplay(docData.blocks); renderPages(); saveHistory(); await ManualRenderer.renderAll(); } catch(err) { alert("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: " + err.message); } }; r.readAsText(file); }
    function loadProjectJSONFromInput(input) { loadProjectFromFile(input.files[0]); }
    function showLoading(msg) { const el=document.getElementById('loading-indicator'); el.innerText=msg; el.style.display='block'; }
    function hideLoading() { document.getElementById('loading-indicator').style.display='none'; }
    function saveHistory() { const cleanData = JSON.parse(JSON.stringify(docData)); cleanData.blocks.forEach(b => b.content = cleanRichContentToTex(b.content)); const str=JSON.stringify(cleanData); if(historyIndex>=0 && historyStack[historyIndex]===str)return; historyIndex++; historyStack=historyStack.slice(0,historyIndex); historyStack.push(str); if(historyStack.length>30){ historyStack.shift(); historyIndex--; } localStorage.setItem('editorAutoSave',str); }
    function saveHistoryDebounced() { clearTimeout(renderTimer); renderTimer=setTimeout(saveHistory,500); }
    
    async function performUndo() { 
        if(historyIndex>0){ 
            historyIndex--; 
            docData=JSON.parse(historyStack[historyIndex]); 
            renderPages(); 
            await ManualRenderer.renderAll(); 
        } 
    }
    async function performRedo() { 
        if(historyIndex<historyStack.length-1){ 
            historyIndex++; 
            docData=JSON.parse(historyStack[historyIndex]); 
            renderPages(); 
            await ManualRenderer.renderAll(); 
        } 
    }

    function updateBlockContent(id, html, recordHistory=true) { const b = docData.blocks.find(x=>x.id===id); if(b) b.content=html; if(recordHistory) saveHistoryDebounced(); }
    
    async function deleteBlockById(id) { 
        docData.blocks = docData.blocks.filter(b=>b.id!==id); 
        renderPages(); 
        await ManualRenderer.renderAll();
        saveHistory(); 
    }
    
    function insertImageBoxSafe() { if(document.activeElement && document.activeElement.isContentEditable) { insertImageBox(); } else { addBlockBelow('image'); } }
    function isCaretOnLastLine(element) { const selection = window.getSelection(); if (selection.rangeCount === 0) return false; const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect(); const elementRect = element.getBoundingClientRect(); return (elementRect.bottom - rect.bottom) < 30; }
    function isCaretOnFirstLine(element) { const selection = window.getSelection(); if (selection.rangeCount === 0) return false; const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect(); const elementRect = element.getBoundingClientRect(); return (rect.top - elementRect.top) < 30; }
    function focusNextBlock(currentId, direction) { const idx = docData.blocks.findIndex(b => b.id === currentId); let nextIdx = idx + direction; while(nextIdx >= 0 && nextIdx < docData.blocks.length) { const nextBlock = docData.blocks[nextIdx]; if (['concept', 'example'].includes(nextBlock.type)) { const nextEl = document.querySelector(`.block-wrapper[data-id="${nextBlock.id}"] .editable-box`); if(nextEl) { nextEl.focus(); const nextWrap = nextEl.closest('.block-wrapper'); nextWrap.classList.add('temp-show-handle'); setTimeout(() => nextWrap.classList.remove('temp-show-handle'), 1000); } return; } nextIdx += direction; } }
    
    async function duplicateTargetBlock() { 
        if(!contextTargetId) return; 
        const idx = docData.blocks.findIndex(b=>b.id===contextTargetId); 
        const clone = JSON.parse(JSON.stringify(docData.blocks[idx])); 
        clone.id = 'copy_'+Date.now(); 
        docData.blocks.splice(idx+1, 0, clone); 
        renderPages(); 
        await ManualRenderer.renderAll(); 
        saveHistory(); 
        document.getElementById('context-menu').style.display='none'; 
    }
    
    async function addBlockBelow(type) { 
        let targetIdx = contextTargetId ? docData.blocks.findIndex(b=>b.id===contextTargetId) : docData.blocks.length-1; 
        const newBlock = createNewBlockData(type); 
        docData.blocks.splice(targetIdx+1, 0, newBlock); 
        if(type!=='break') lastFocusId = newBlock.id; 
        renderPages(); 
        await ManualRenderer.renderAll(); 
        saveHistory(); 
        document.getElementById('context-menu').style.display='none'; 
    }
    
    async function addBlockAbove(type) { 
        if(!contextTargetId) return; 
        let targetIdx = docData.blocks.findIndex(b=>b.id===contextTargetId); 
        const newBlock = createNewBlockData(type); 
        docData.blocks.splice(targetIdx, 0, newBlock); 
        lastFocusId = newBlock.id; 
        renderPages(); 
        await ManualRenderer.renderAll(); 
        saveHistory(); 
        document.getElementById('context-menu').style.display='none'; 
    }
    
    function createNewBlockData(type) { const newBlock = { id:'b_'+Date.now(), type:type, content:'' }; if(type==='concept') newBlock.content='<span class="q-label">ê°œë…</span> '; if(type==='image') { newBlock.type='example'; newBlock.content='<span class="image-placeholder" contenteditable="false">ì´ë¯¸ì§€ ë°•ìŠ¤ (Click to Select)</span>'; } if(type==='break') newBlock.type='break'; if(type==='spacer') { newBlock.type='spacer'; newBlock.height=50; } return newBlock; }
    
    async function deleteTargetBlock() { 
        if(contextTargetId) await deleteBlockById(contextTargetId); 
        document.getElementById('context-menu').style.display='none'; 
    }
    
    async function applyAlign(align) { const b = docData.blocks.find(x=>x.id===contextTargetId); if(b) { if(!b.style) b.style={}; b.style.textAlign=align; } renderPages(); await ManualRenderer.renderAll(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    async function toggleGrayBg() { const b = docData.blocks.find(x=>x.id===contextTargetId); if(b) b.bgGray = !b.bgGray; renderPages(); await ManualRenderer.renderAll(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    async function toggleBorder() { const b = docData.blocks.find(x=>x.id===contextTargetId); if(b) b.bordered = !b.bordered; renderPages(); await ManualRenderer.renderAll(); saveHistory(); document.getElementById('context-menu').style.display='none'; }
    
    function insertImageBox() { document.execCommand('insertHTML', false, `<span class="image-placeholder" contenteditable="false">ì´ë¯¸ì§€ ë°•ìŠ¤ (Click to Select)</span>`); document.getElementById('context-menu').style.display='none'; }
    function execStyle(cmd, val=null) { document.execCommand(cmd, false, val); }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function executeFindReplace() { const findStr = document.getElementById('fr-find-input').value; const repStr = document.getElementById('fr-replace-input').value; if (!findStr) return; docData.blocks.forEach(block => { block.content = block.content.replaceAll(findStr, repStr); }); renderPages(); ManualRenderer.renderAll(); saveHistory(); closeModal('find-replace-modal'); }
    function showResizer(img) { selectedImage = img; const resizer = document.getElementById('image-resizer'); const rect = img.getBoundingClientRect(); resizer.style.display = 'block'; resizer.style.top = (rect.top + window.scrollY) + 'px'; resizer.style.left = (rect.left + window.scrollX) + 'px'; resizer.style.width = rect.width + 'px'; resizer.style.height = rect.height + 'px'; }
    function hideResizer() { document.getElementById('image-resizer').style.display = 'none'; selectedImage = null; }
    function initResizeImage(e) { e.preventDefault(); e.stopPropagation(); if(!selectedImage) return; const startX = e.clientX, startY = e.clientY; const startW = selectedImage.offsetWidth, startH = selectedImage.offsetHeight; const zoom = docData.meta.zoom || 1.0; function doDrag(evt) { const newW = Math.max(20, startW + (evt.clientX - startX) / zoom); const newH = Math.max(20, startH + (evt.clientY - startY) / zoom); selectedImage.style.width = newW + 'px'; selectedImage.style.height = newH + 'px'; showResizer(selectedImage); } function stopDrag() { window.removeEventListener('mousemove', doDrag); window.removeEventListener('mouseup', stopDrag); updateBlockContent(selectedImage.closest('.block-wrapper').dataset.id, selectedImage.closest('.editable-box').innerHTML); } window.addEventListener('mousemove', doDrag); window.addEventListener('mouseup', stopDrag); }
    
    function handleImageUpload(e) { 
        if(!selectedPlaceholder || !e.target.files[0]) return;
        const file = e.target.files[0];
        const replaceImage = (url, path) => { const newImg = document.createElement('img'); newImg.src = url; if(path) newImg.dataset.path = path; newImg.style.maxWidth = '100%'; selectedPlaceholder.replaceWith(newImg); updateBlockContent(newImg.closest('.block-wrapper').dataset.id, newImg.closest('.editable-box').innerHTML); selectedPlaceholder = null; };
        if(FileSystem.dirHandle) { FileSystem.saveImage(file).then(saved => { if(saved) replaceImage(saved.url, saved.path); }); } 
        else { const r=new FileReader(); r.onload=(evt)=>{ replaceImage(evt.target.result, null); }; r.readAsDataURL(file); }
        e.target.value='';
    }
    
    function confirmImport(overwrite) {
        const input = document.getElementById('import-textarea').value.trim(); if(!input) return;
        const limit = parseInt(document.getElementById('setting-limit').value) || 0; const addSpacer = document.getElementById('setting-spacer').checked;
        let finalBlocks = [];
        try {
            let isJson = false; let parsedJson = null;
            if (input.startsWith('[') || input.startsWith('{')) { try { parsedJson = JSON.parse(input); if (typeof parsedJson === 'object' && parsedJson !== null) isJson = true; } catch (e) {} }
            if (isJson) { const arr = Array.isArray(parsedJson) ? parsedJson : [parsedJson]; finalBlocks = arr.map(item => ({ id: 'imp_json_' + Date.now() + Math.random(), type: item.type || 'example', content: item.content || '', bordered: item.bordered || false, bgGray: item.bgGray || false })); } 
            else if (input.includes('<div') && input.includes('data-item')) { const parser = new DOMParser(); const doc = parser.parseFromString(input, 'text/html'); const items = doc.querySelectorAll('.data-item'); items.forEach(i => { let t = 'example', c = i.innerHTML; if(i.querySelector('.concept-box')) { t = 'concept'; c = i.querySelector('.concept-box').innerHTML; } else if(i.querySelector('.answer-area')) { t = 'answer'; c = i.querySelector('.answer-area').innerHTML; } finalBlocks.push({ id: 'imp_html_' + Date.now() + Math.random(), type: t, content: c }); }); } 
            else { finalBlocks = ImportParser.parse(input); }
            let processedBlocks = []; let countInColumn = 0;
            finalBlocks.forEach((b, idx) => { processedBlocks.push(b); if(b.type !== 'answer') { countInColumn++; if(addSpacer) processedBlocks.push({id:'sp_'+Math.random(), type:'spacer', height:50}); } if (limit > 0 && countInColumn >= limit && idx < finalBlocks.length - 1) { processedBlocks.push({id:'br_'+Math.random(), type:'break'}); countInColumn = 0; } });
            if(overwrite) docData.blocks = processedBlocks; else docData.blocks = docData.blocks.concat(processedBlocks);
            closeModal('import-modal'); 
            
            (async () => {
                renderPages(); 
                await ManualRenderer.renderAll(); 
                saveHistory();
            })();
        } catch(e) { console.error(e); alert("ë°ì´í„° ì¸ì‹ ì‹¤íŒ¨: "+e.message); }
    }

    function resetProject(){ if(confirm('ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì €ì¥ë˜ì§€ ì•Šì€ ë‚´ìš©ì€ ì‚­ì œë©ë‹ˆë‹¤)')) { docData.blocks=[{ id: 'b0', type: 'concept', content: '<span class="q-label">ì•ˆë‚´</span> ë‚´ìš© ì…ë ¥...' }]; renderPages(); saveHistory(); } }
    async function printWithMath(){ showLoading("ğŸ–¨ï¸ ì¸ì‡„ ì¤€ë¹„ ì¤‘..."); window.print(); hideLoading(); }

    window.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('editorAutoSave');
        if(saved) { try { docData = JSON.parse(saved); } catch(e) { console.error("AutoSave Load Failed"); } }
        renderPages(); saveHistory(); 
        document.addEventListener('mousedown', handleClickOutside);
        document.addEventListener('mouseup', handleGlobalMouseUp);
        document.addEventListener('keydown', handleGlobalKeydown);
        document.addEventListener('keyup', (e) => keysPressed[e.key.toLowerCase()] = false);
        document.addEventListener('paste', handleGlobalPaste);
        document.addEventListener('dblclick', handleGlobalDblClick);
        document.getElementById('imgUpload').addEventListener('change', handleImageUpload);
        const resizeHandle = document.querySelector('.resizer-handle');
        if(resizeHandle) resizeHandle.addEventListener('mousedown', initResizeImage);
        
        const zoomRange = document.getElementById('zoomRange');
        zoomRange.addEventListener('input', (e) => { 
            const z = parseFloat(e.target.value);
            docData.meta.zoom = z; 
            const container = document.getElementById('paper-container');
            container.style.transform = `scale(${z})`;
            container.style.transformOrigin = 'top center';
        });
        zoomRange.addEventListener('change', async (e) => { 
            renderPages(); 
            await ManualRenderer.renderAll(); 
        });
        
        const body = document.body;
        body.addEventListener('dragover', (e) => { 
            if(dragSrcId) return; 
            e.preventDefault(); 
            body.classList.add('drag-over'); 
        });
        body.addEventListener('dragleave', (e) => { if(!e.relatedTarget) body.classList.remove('drag-over'); });
        
        // [Fix] Body ë“œë¡­ í•¸ë“¤ëŸ¬ ë³´ì™„: íŒŒì¼ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
        body.addEventListener('drop', (e) => {
            if(dragSrcId) return; 
            
            // íŒŒì¼ì´ í¬í•¨ë˜ì§€ ì•Šì€ ë“œë¡­(ex: í…ìŠ¤íŠ¸ ì´ë™)ì´ë©´ ê·¸ëƒ¥ ë¬´ì‹œ
            const types = e.dataTransfer.types;
            if (types && !Array.from(types).includes('Files')) {
                return;
            }

            e.preventDefault(); body.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if(file) {
                if(file.name.endsWith('.json')) loadProjectFromFile(file); 
                else {
                    const r = new FileReader();
                    r.onload = (ev) => { document.getElementById('import-textarea').value = ev.target.result; openModal('import-modal'); };
                    r.readAsText(file);
                }
            }
        });
        
        // [ì¶”ê°€] ìŠ¤í¬ë¡¤ ì‹œ ë©”ë‰´ ë‹«ê¸°
        window.addEventListener('scroll', () => {
            document.getElementById('context-menu').style.display = 'none';
            document.getElementById('floating-toolbar').style.display = 'none';
        }, true);

        console.log("ğŸš€ Editor System Initialized (v3.9.5 Fixed & UX Improved)");
    });
</script>
</body>
</html>